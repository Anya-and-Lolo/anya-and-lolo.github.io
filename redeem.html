<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Patreon Rewards</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 980px; margin: 30px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .row { display:flex; gap: 12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; cursor:pointer; background:#fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    code { font-size: 14px; }
    .muted { color:#666; font-size: 13px; }
    .keybox { background:#fafafa; padding:10px; border-radius:10px; border:1px dashed #ccc; }
    .storeGrid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    .storeImg { width: 100%; height: 245px; object-fit: contain; background: #fff; border-radius: 12px; border: 1px solid #eee; }
    .toast {
      display:none;
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }
:root{
  --dot1: rgba(255, 182, 193, 0.45); /* pink */
  --dot2: rgba(173, 216, 230, 0.45); /* blue */
  --dot3: rgba(221, 160, 221, 0.38); /* purple */
  --dot4: rgba(255, 250, 205, 0.45); /* lemon */
}

body{
  position: relative;
  overflow-x: hidden;
}

/* animated pastel dot pattern */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  z-index: -2;
  background:
    radial-gradient(circle, var(--dot1) 2px, transparent 3px) 0 0/38px 38px,
    radial-gradient(circle, var(--dot2) 2px, transparent 3px) 12px 10px/44px 44px,
    radial-gradient(circle, var(--dot3) 2px, transparent 3px) 22px 26px/52px 52px,
    radial-gradient(circle, var(--dot4) 2px, transparent 3px) 6px 30px/58px 58px;
  animation: dotsFloat 18s linear infinite;
  filter: blur(0.2px);
  opacity: 0.9;
}

/* soft ‚Äúpaper‚Äù overlay so dots don‚Äôt compete with text */
body::after{
  content:"";
  position: fixed;
  inset: 0;
  z-index: -1;
  background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.92));
}

@keyframes dotsFloat{
  from { transform: translate3d(0,0,0); }
  to   { transform: translate3d(-120px, -90px, 0); }
}

  </style>
</head>
<body>
  <h1>Patreon Rewards</h1>

  <button id="connect">Connect Patreon</button>
  <p id="status">Loading‚Ä¶</p>

  <h2>Rewards Store</h2>
  <div id="store" class="storeGrid"></div>

  <h2>Your Unlocks</h2>
  <div id="unlocks" class="muted">Redeem something to see it here.</div>

  <div id="toast" class="toast"></div>

  <script>
    const API = "https://patreon-redeem-api.lady-anya.workers.dev";

    // Images for store items (by item id)
    const ITEM_IMAGES = {
      fishing_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/fishing_system_image.jpg",
      visual_novel_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/VN_system_image.jpg",
      shooting_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/shooting_system_image.jpg",
    };

    document.getElementById("connect").onclick = () => {
      location.href = API + "/auth/patreon/start";
    };

    // (Your flow stores session from querystring)
    const params = new URLSearchParams(location.search);
    const session = params.get("session");
    if (session) localStorage.setItem("session", session);

    function getSession() {
      return localStorage.getItem("session");
    }

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => (t.style.display = "none"), 2200);
    }

    function isProbablyUrl(s) {
      return typeof s === "string" && /^https?:\/\//i.test(s.trim());
    }

    async function loadMe() {
      const s = getSession();
      if (!s) {
        document.getElementById("status").textContent = "Not connected";
        return null;
      }
      const r = await fetch(API + "/me?session=" + encodeURIComponent(s));
      const me = await r.json();
      document.getElementById("status").textContent =
        me.loggedIn ? `Credits: ${me.credits}` : "Not connected";
      return me;
    }

    // Prevent double-click redeems: track active redeems by item id
    const redeeming = new Set();

    async function loadStore() {
      const r = await fetch(API + "/store");
      const data = await r.json();
      const el = document.getElementById("store");
      el.innerHTML = "";

      (data.items || []).forEach(item => {
        const dollars = (item.cost_cents / 100).toFixed(2);
        const remaining = item.remaining ?? 0;
        const img = ITEM_IMAGES[item.id] || "";

        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          ${img ? `<img class="storeImg" src="${img}" alt="${item.name}">` : ""}
          <div class="row" style="margin-top:10px">
            <div>
              <strong>${item.name}</strong><br>
              <span class="muted">$${dollars} credits ‚Ä¢ Remaining keys: ${remaining}</span>
            </div>
            <button ${remaining <= 0 ? "disabled" : ""} data-id="${item.id}">
              Redeem
            </button>
          </div>
          <div class="muted" style="margin-top:8px">${item.payload?.instructions || ""}</div>
        `;

        const btn = div.querySelector("button");
        btn.onclick = () => redeem(item.id, btn);
        el.appendChild(div);
      });
    }

    async function loadUnlocks() {
      const s = getSession();
      const box = document.getElementById("unlocks");

      if (!s) {
        box.classList.add("muted");
        box.textContent = "Connect Patreon to see your unlocks.";
        return;
      }

      const r = await fetch(API + "/entitlements?session=" + encodeURIComponent(s));
      const data = await r.json();

      if (!r.ok) {
        box.classList.add("muted");
        box.textContent = data.error || "Could not load unlocks.";
        return;
      }

      if (!data.items || data.items.length === 0) {
        box.classList.add("muted");
        box.textContent = "Redeem something to see it here.";
        return;
      }

      box.classList.remove("muted");
      box.innerHTML = "";

      data.items.forEach(ent => {
        const title = ent.payload?.title || ent.item_id;

        // Your worker may return:
        // - payload.itch_key_url (a full URL)
        // - payload.itch_key (a code OR a URL, depending how you stored it)
        // - payload.url (legacy)
        const raw = ent.payload?.itch_key_url || ent.payload?.itch_key || ent.payload?.url || "";
        addUnlock(title, raw);
      });
    }

    function addUnlock(title, rawKeyOrUrl) {
      const box = document.getElementById("unlocks");
      if (box.classList.contains("muted")) box.classList.remove("muted");

      const isUrl = isProbablyUrl(rawKeyOrUrl);
      const keyLabel = isUrl ? "Your itch.io key link:" : "Your itch.io key code:";
      const openHref = isUrl ? rawKeyOrUrl : "https://itch.io/claim";
      const openText = isUrl ? "Open key ‚Üí" : "Open itch.io claim ‚Üí";

      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <strong>${title}</strong>
        <div class="keybox" style="margin-top:8px">
          <div>${keyLabel}</div>
          <div><code class="key">${rawKeyOrUrl || "(missing key)"}</code></div>
          <div style="margin-top:8px" class="row">
            <button class="copy">Copy</button>
            <a class="open" href="${openHref}" target="_blank" rel="noopener">${openText}</a>
          </div>
          <div class="muted" style="margin-top:8px">
            üíõ Thank you for supporting Anya & Lolo! Please don‚Äôt share your key.
          </div>
        </div>
      `;

      wrap.querySelector(".copy").onclick = async () => {
        await navigator.clipboard.writeText(rawKeyOrUrl || "");
        showToast("Copied! üíõ");
      };

      box.prepend(wrap);
    }

    async function redeem(itemId, buttonEl) {
      const s = getSession();
      if (!s) {
        alert("Connect Patreon first.");
        return;
      }

      // Double-click protection
      if (redeeming.has(itemId)) return;
      redeeming.add(itemId);

      const originalText = buttonEl ? buttonEl.textContent : "";
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = "Redeeming‚Ä¶";
      }

      try {
        const r = await fetch(API + "/redeem?session=" + encodeURIComponent(s), {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ itemId })
        });

        const out = await r.json();

        if (!r.ok) {
          alert(out.error || "Redeem failed");
          return;
        }

        // ‚úÖ Instant display
        const raw = out.payload?.itch_key_url || out.payload?.itch_key || out.payload?.url || "";
        if (raw) {
          addUnlock(out.item?.name || itemId, raw);
          showToast("üéâ Reward unlocked! Thank you for supporting üíõ");
        } else {
          showToast("‚úÖ Redeemed! (No key returned)");
        }

        // ‚úÖ Authoritative refresh (server truth)
        await loadMe();
        await loadStore();
        await loadUnlocks();

      } finally {
        redeeming.delete(itemId);
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = originalText || "Redeem";
        }
      }
    }

    (async () => {
      await loadMe();
      await loadStore();
      await loadUnlocks();
    })();
  </script>
</body>
</html>


