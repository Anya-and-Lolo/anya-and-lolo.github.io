<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patreon Rewards â€¢ Anya & Lolo</title>
  <meta name="description" content="Connect Patreon, view credits, and redeem itch.io keys for Anya & Lolo rewards." />

  <style>
    :root{
      --brand: #f4184c;
      --brand2: rgba(244, 24, 76, 0.12);

      --bg: #ffffff;
      --card: rgba(255,255,255,0.88);
      --border: rgba(20,20,20,0.10);
      --text: #1b1b1b;
      --muted: rgba(27,27,27,0.70);

      --radius: 16px;
      --shadow: 0 10px 28px rgba(0,0,0,.10);
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
      font-size: 17px;
      line-height: 1.6;
    }

    /* tidy 2D dot pattern */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      opacity: 0.95;
      background:
        radial-gradient(circle, rgba(244,24,76,0.16) 2px, transparent 2.5px) 0 0/36px 36px,
        radial-gradient(circle, rgba(86,167,254,0.14) 2px, transparent 2.5px) 18px 18px/36px 36px;
      animation: dotsFloat 22s linear infinite;
    }
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(255,255,255,0.70);
    }
    @keyframes dotsFloat{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(-120px, -90px, 0); }
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; text-underline-offset: 4px; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Top bar (same vibe as homepage) */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.65);
      border-bottom: 1px solid var(--border);
    }

    .topbarInner{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: 0.2px;
      white-space: nowrap;
      font-size: 20px;
    }

    .badge{
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.8);
      color: var(--muted);
      font-weight: 800;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .navlink{
      font-weight: 900;
      font-size: 15px;
      color: rgba(27,27,27,0.85);
      padding: 9px 12px;
      border-radius: 999px;
    }
    .navlink:hover{
      text-decoration: none;
      background: rgba(0,0,0,0.06);
    }

    /* Page header */
    h1{
      margin: 14px 0 6px;
      font-size: 34px;
      letter-spacing: -0.5px;
      line-height: 1.15;
    }
    .sub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 16px;
    }

    /* Buttons */
    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
      font-weight: 900;
    }
    button:disabled{ opacity: .6; cursor: not-allowed; }

    .btnPrimary{
      background: var(--brand);
      color: #fff;
      border-color: rgba(244,24,76,0.35);
    }

    /* Cards â€“ white like homepage */
    .card{
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      margin: 12px 0;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    code{ font-size: 14px; }
    .muted{ color: rgba(27,27,27,0.70); font-size: 13px; }

    .keybox{
      background:#fff;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(20,20,20,0.18);
    }

    .storeGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .storeImg{
      width: 100%;
      height: 240px;
      object-fit: contain;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(20,20,20,0.08);
    }

    .toast{
      display:none;
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index: 20;
    }

    /* Footer (same structure as homepage) */
    footer{
      margin-top: 26px;
      padding: 18px 0 34px;
      color: rgba(27,27,27,0.72);
      font-size: 14px;
    }

    .hangout{
      text-align: center;
      margin: 18px 0 14px;
      font-size: 15px;
      color: rgba(27,27,27,0.78);
    }

    .footerInner{
      border-top: 1px solid var(--border);
      padding-top: 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items:center;
    }

    .socialText{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:center;
      align-items:center;
      font-weight: 900;
    }

    .socialText a{
      padding: 2px 6px;
      border-radius: 10px;
      text-decoration: none;
    }
    .socialText a:hover{
      background: rgba(0,0,0,0.06);
      text-decoration: none;
    }

    .sepDot{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--brand);
      font-size: 28px;     /* change size here */
      line-height: 1;
      margin: 0 10px;
      transform: translateY(1px);
      opacity: 0.85;
    }

    .footerRight{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .sep{
      color: rgba(20,20,20,0.35);
      font-weight: 800;
      margin: 0 2px;
    }

    @media (max-width: 900px){
      .topbarInner{ align-items: flex-start; flex-direction: column; }
      nav{ justify-content: flex-start; }
      .footerInner{ grid-template-columns: 1fr; text-align:center; }
      .footerRight{ justify-content: center !important; }
      .socialText{ justify-content: center !important; }
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <a href="./">Anya &amp; Lolo</a>
        <span class="badge">Patreon Rewards</span>
      </div>

      <nav aria-label="Primary">
        <a class="navlink" href="./">Home</a>
        <a class="navlink" href="./redeem.html">Patreon Rewards</a>
        <a class="navlink" href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Smart Systems</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Patreon Rewards</h1>
    <p class="sub">Connect Patreon, view your credits, and redeem your itch.io keys.</p>

    <div class="row" style="margin: 10px 0 14px;">
      <button id="connect" class="btnPrimary">Connect Patreon</button>
      <div id="status" class="muted">Loadingâ€¦</div>
    </div>

    <h2 style="margin: 18px 0 10px;">Rewards Store</h2>
    <div id="store" class="storeGrid"></div>

    <h2 style="margin: 22px 0 10px;">Your Unlocks</h2>
    <div id="unlocks" class="muted">Redeem something to see it here.</div>

    <div id="toast" class="toast"></div>

    <footer>
      <div class="hangout">
        Want to hang out? Join the
        <a href="https://discord.com/invite/4Pyb5SQTdn" target="_blank" rel="noopener" style="color:var(--brand); font-weight:900;">Discord</a>
        or follow us on your favourite platform below ðŸ’›
      </div>

      <div class="footerInner">
        <div>Â© <span id="year"></span> Anya &amp; Lolo</div>

        <div class="socialText" aria-label="Social links">
          <a href="https://www.youtube.com/@Anya_and_Lolo" target="_blank" rel="noopener">YouTube</a>
          <a href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Itch</a>
          <a href="https://www.patreon.com/anya_and_lolo" target="_blank" rel="noopener">Patreon</a>

          <span class="sepDot">â€¢</span>

          <a href="https://www.instagram.com/anya_and_lolo" target="_blank" rel="noopener">Insta</a>
          <a href="https://tiktok.com/@anya_and_lolo" target="_blank" rel="noopener">TikTok</a>
          <a href="https://www.facebook.com/316257814895497" target="_blank" rel="noopener">Facebook</a>

          <span class="sepDot">â€¢</span>

          <a href="https://bsky.app/profile/anya-and-lolo.itch.io" target="_blank" rel="noopener">Bluesky</a>
          <a href="https://x.com/Anya_and_Lolo" target="_blank" rel="noopener">X</a>

          <span class="sepDot">â€¢</span>

          <a href="https://www.pixiv.net/en/users/105118068" target="_blank" rel="noopener">Pixiv</a>
          <a href="https://anya-and-lolo.booth.pm/" target="_blank" rel="noopener">Booth</a>
        </div>

        <div class="footerRight">
          <a href="./terms.html">Terms</a>
          <span class="sep">|</span>
          <a href="./privacy.html">Privacy</a>
        </div>
      </div>
    </footer>
  </main>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const API = "https://patreon-redeem-api.lady-anya.workers.dev";

    const ITEM_IMAGES = {
      fishing_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/fishing_system_image.jpg",
      visual_novel_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/VN_system_image.jpg",
      shooting_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/shooting_system_image.jpg",
    };

    document.getElementById("connect").onclick = () => {
      location.href = API + "/auth/patreon/start";
    };

    const params = new URLSearchParams(location.search);
    const session = params.get("session");
    if (session) localStorage.setItem("session", session);

    function getSession() {
      return localStorage.getItem("session");
    }

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => (t.style.display = "none"), 2200);
    }

    function isProbablyUrl(s) {
      return typeof s === "string" && /^https?:\/\//i.test(s.trim());
    }

    async function loadMe() {
      const s = getSession();
      const statusEl = document.getElementById("status");

      if (!s) {
        statusEl.textContent = "Available Credits: not connected";
        return null;
      }

      const r = await fetch(API + "/me?session=" + encodeURIComponent(s));
      const me = await r.json();

      if (!me.loggedIn) {
        statusEl.textContent = "Available Credits: not connected";
        return null;
      }

      statusEl.textContent = `Available Credits: ${me.credits}`;
      return me;
    }

    const redeeming = new Set();

    async function loadStore() {
      const r = await fetch(API + "/store");
      const data = await r.json();
      const el = document.getElementById("store");
      el.innerHTML = "";

      (data.items || []).forEach(item => {
        const dollars = (item.cost_cents / 100).toFixed(2);
        const remaining = item.remaining ?? 0;
        const img = ITEM_IMAGES[item.id] || "";

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${img ? `<img class="storeImg" src="${img}" alt="${item.name}">` : ""}
          <div class="row" style="margin-top:10px">
            <div>
              <strong>${item.name}</strong><br>
              <span class="muted">$${dollars} credits â€¢ Remaining keys: ${remaining}</span>
            </div>
            <button ${remaining <= 0 ? "disabled" : ""} data-id="${item.id}">
              Redeem
            </button>
          </div>
          <div class="muted" style="margin-top:8px">${item.payload?.instructions || ""}</div>
        `;

        const btn = div.querySelector("button");
        btn.onclick = () => redeem(item.id, btn);
        el.appendChild(div);
      });
    }

    async function loadUnlocks() {
      const s = getSession();
      const box = document.getElementById("unlocks");

      if (!s) {
        box.classList.add("muted");
        box.textContent = "Connect Patreon to see your unlocks.";
        return;
      }

      const r = await fetch(API + "/entitlements?session=" + encodeURIComponent(s));
      const data = await r.json();

      if (!r.ok) {
        box.classList.add("muted");
        box.textContent = data.error || "Could not load unlocks.";
        return;
      }

      if (!data.items || data.items.length === 0) {
        box.classList.add("muted");
        box.textContent = "Redeem something to see it here.";
        return;
      }

      box.classList.remove("muted");
      box.innerHTML = "";

      data.items.forEach(ent => {
        const title = ent.payload?.title || ent.item_id;
        const raw = ent.payload?.itch_key_url || ent.payload?.itch_key || ent.payload?.url || "";
        addUnlock(title, raw);
      });
    }

    function addUnlock(title, rawKeyOrUrl) {
      const box = document.getElementById("unlocks");
      if (box.classList.contains("muted")) box.classList.remove("muted");

      const isUrl = isProbablyUrl(rawKeyOrUrl);
      const keyLabel = isUrl ? "Your itch.io key link:" : "Your itch.io key code:";
      const openHref = isUrl ? rawKeyOrUrl : "https://itch.io/claim";
      const openText = isUrl ? "Open key â†’" : "Open itch.io claim â†’";

      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <strong>${title}</strong>
        <div class="keybox" style="margin-top:8px">
          <div>${keyLabel}</div>
          <div><code class="key">${rawKeyOrUrl || "(missing key)"}</code></div>
          <div style="margin-top:8px" class="row">
            <button class="copy">Copy</button>
            <a class="open" href="${openHref}" target="_blank" rel="noopener">${openText}</a>
          </div>
          <div class="muted" style="margin-top:8px">
            ðŸ’› Thank you for supporting Anya & Lolo! Please donâ€™t share your key.
          </div>
        </div>
      `;

      wrap.querySelector(".copy").onclick = async () => {
        await navigator.clipboard.writeText(rawKeyOrUrl || "");
        showToast("Copied! ðŸ’›");
      };

      box.prepend(wrap);
    }

    async function redeem(itemId, buttonEl) {
      const s = getSession();
      if (!s) {
        alert("Connect Patreon first.");
        return;
      }

      if (redeeming.has(itemId)) return;
      redeeming.add(itemId);

      const originalText = buttonEl ? buttonEl.textContent : "";
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = "Redeemingâ€¦";
      }

      try {
        const r = await fetch(API + "/redeem?session=" + encodeURIComponent(s), {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ itemId })
        });

        const out = await r.json();

        if (!r.ok) {
          alert(out.error || "Redeem failed");
          return;
        }

        const raw = out.payload?.itch_key_url || out.payload?.itch_key || out.payload?.url || "";
        if (raw) {
          addUnlock(out.item?.name || itemId, raw);
          showToast("ðŸŽ‰ Reward unlocked! Thank you for supporting ðŸ’›");
        } else {
          showToast("âœ… Redeemed! (No key returned)");
        }

        await loadMe();
        await loadStore();
        await loadUnlocks();
      } finally {
        redeeming.delete(itemId);
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = originalText || "Redeem";
        }
      }
    }

    (async () => {
      await loadMe();
      await loadStore();
      await loadUnlocks();
    })();
  </script>
</body>
</html>
