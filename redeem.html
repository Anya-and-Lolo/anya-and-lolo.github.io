<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patreon Rewards â€¢ Anya & Lolo</title>
  <meta name="description" content="Connect Patreon, view credits, and redeem itch.io keys for Anya & Lolo rewards." />

  <style>
    :root{
      --brand: #f4184c;
      --brand2: rgba(244, 24, 76, 0.12);

      --bg: #ffffff;
      --card: rgba(255,255,255,0.88);
      --border: rgba(20,20,20,0.10);
      --text: #1b1b1b;
      --muted: rgba(27,27,27,0.70);

      --radius: 16px;
      --shadow: 0 10px 28px rgba(0,0,0,.10);
    }

    *{ box-sizing: border-box; }
    html, body{
      height: auto;              /* override the 100% height if needed */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
      font-size: 17px;
      line-height: 1.6;
    }

    /* animated pastel dot pattern */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      opacity: 1;
      background:
        radial-gradient(circle, rgba(244,24,76,0.22) 2px, transparent 3.5px) 0 0/42px 42px,
        radial-gradient(circle, rgba(86,167,254,0.20) 2px, transparent 3.5px) 21px 21px/42px 42px;
      animation: dotsFloat 22s linear infinite;
    }
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(255, 250, 252, 0.45);
    }
    @keyframes dotsFloat{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(-120px, -90px, 0); }
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; text-underline-offset: 4px; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Buttons */
    button, .navlink, a{
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    
    button:active, .navlink:active{
      transform: translateY(1px) scale(0.99);
    }
    
    .btnPrimary:hover{
      box-shadow: 0 14px 30px rgba(244,24,76,.20);
      transform: translateY(-1px);
    }

    /* Sparkle pop */
    a.pop{ animation: pop .28s ease; }
    @keyframes pop{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.04); }
      100%{ transform: scale(1); }
    }
    
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.65);
      border-bottom: 1px solid var(--border);
    }

    .topbarInner{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: 0.2px;
      white-space: nowrap;
      font-size: 20px;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

      nav{
        width: 100%;
        flex-wrap: nowrap;          /* no wrapping */
        justify-content: flex-start;
        overflow-x: auto;           /* allow swipe */
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;      /* Firefox hide */
      }
      nav::-webkit-scrollbar{ display:none; } /* Chrome/Safari hide */
    
      .navlink{
        white-space: nowrap;        /* keep each pill intact */
        flex: 0 0 auto;
      }
    }

    .navlink{
      font-weight: 900;
      font-size: 15px;
      color: rgba(27,27,27,0.85);
      padding: 9px 12px;
      border-radius: 999px;
    }
    .navlink:hover{
      text-decoration: none;
      background: rgba(0,0,0,0.06);
    }

    .badge{
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.8);
      color: var(--muted);
      font-weight: 800;
    }
    
    /* Page header */
    h1{
      margin: 14px 0 6px;
      font-size: 34px;
      letter-spacing: -0.5px;
      line-height: 1.15;
    }
    .sub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 16px;
    }

    /* Buttons */
    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
      font-weight: 900;
    }
    button:disabled{ opacity: .6; cursor: not-allowed; }

    .btnPrimary{
      background: var(--brand);
      color: #fff;
      border-color: rgba(244,24,76,0.35);
    }

    /* Cards â€“ white like homepage */
    .card{
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      margin: 12px 0;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    code{ font-size: 14px; }
    .muted{ color: rgba(27,27,27,0.70); font-size: 13px; }

    .keybox{
      background:#fff;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(20,20,20,0.18);
    }

    .storeGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .storeImg{
      width: 100%;
      height: 240px;
      object-fit: contain;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(20,20,20,0.08);
    }

    .toast{
      display:none;
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index: 20;
    }

    .storeButton{
      margin-top: 10px;
      width: 100%;
    }
    
    /* Footer (same structure as homepage) */
    footer{
      margin-top: 26px;
      padding: 18px 0 34px;
      color: rgba(27,27,27,0.72);
      font-size: 14px;
    }

    .creditsLine{
      font-size: 14px;
      color: rgba(27,27,27,0.80);
      font-weight: 800;
    }
    .creditsLine strong{
      font-size: 16px;
      font-weight: 1000;
    }

    .patreonRow{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 8px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      font-size: 13px;
      color: #333;
    }
    .pillDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
    }

    .pill--green .pillDot{ background:#22c55e; }
    .pill--amber .pillDot{ background:#f59e0b; }
    .pill--red   .pillDot{ background:#ef4444; }
    .pill--gray  .pillDot{ background:#9ca3af; }

    .infoBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .infoBtn:hover{ background: rgba(0,0,0,0.06); }

    /* Popup */
    .infoPop{
      position: fixed;
      inset: 0;
      display:none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
      background: rgba(0,0,0,0.18);
    }
    .infoPop.show{ display:flex; }

    .infoPopInner{
      width: min(520px, 100%);
      background: #fff;
      border: 1px solid rgba(20,20,20,0.14);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
    }
    .infoPopTitle{ font-weight: 1000; margin-bottom: 8px; }
    .infoPopBody{ font-size: 14px; color: #333; line-height: 1.5; }

    .infoClose{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .hangout{
      text-align: center;
      margin: 18px 0 14px;
      font-size: 15px;
      color: rgba(27,27,27,0.78);
    }

    /* Inline store messages (replaces toast) */
    .storeMsg{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.12);
      background: rgba(255,255,255,0.9);
      font-size: 13px;
      color: rgba(27,27,27,0.86);
      display: none;
    }
    .storeMsg.show{ display: block; }
    
    .storeMsg--success{
      border-color: rgba(34,197,94,0.30);
      background: rgba(34,197,94,0.10);
    }
    .storeMsg--error{
      border-color: rgba(239,68,68,0.30);
      background: rgba(239,68,68,0.10);
    }
    .storeMsg--info{
      border-color: rgba(86,167,254,0.30);
      background: rgba(86,167,254,0.10);
    }
    
    .footerInner{
      border-top: 1px solid var(--border);
      padding-top: 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items:center;
    }

    .socialText{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:center;
      align-items:center;
      font-weight: 900;
    }

    .socialText a{
      padding: 2px 6px;
      border-radius: 10px;
      text-decoration: none;
    }
    .socialText a:hover{
      background: rgba(0,0,0,0.06);
      text-decoration: none;
    }

    .sepDot{
      width: 6px;
      height: 6px;
      background: var(--brand);
      border-radius: 50%;
      display: inline-block;
      margin: 0 10px;
    }

    .footerRight{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .sep{
      color: rgba(20,20,20,0.35);
      font-weight: 800;
      margin: 0 2px;
    }
   
    @media (max-width: 900px){
      html, body{ height: auto; }
      .topbarInner{ align-items: flex-start; flex-direction: column; align-items: center;}
      nav{ justify-content: flex-start; }
      .footerInner{ grid-template-columns: 1fr; text-align:center; }
      .footerRight{ justify-content: center !important; }
      .socialText{ justify-content: center !important; }
    }

    /* Allow page scroll even if a sparkle/canvas overlay exists */
    canvas, 
    #sparkles, 
    .sparkles, 
    .sparkle-canvas,
    [class*="sparkle"]{
      pointer-events: none !important;
      touch-action: none !important;
    }

  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <span class="badge">Systems â€¢ Mechanics â€¢ Game Development</span>
      </div>

      <nav aria-label="Primary">
        <a class="navlink" href="./">Home</a>
        <a class="navlink" href="./redeem.html">Patreon Rewards</a>
        <a class="navlink" href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Smart Systems</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Patreon Rewards</h1>
    <p class="sub">Connect Patreon, view your credits, and redeem your itch.io keys.</p>

    <div class="card" style="margin: 10px 0 14px;">
      <div class="row">
        <button id="connect" class="btnPrimary">Connect Patreon</button>

        <div style="text-align:right;">
          <div class="creditsLine">
            Available Credits: <strong id="creditsValue">â€”</strong>
          </div>

          <div class="patreonRow">
            <span id="patreonPill" class="pill pill--gray">
              <span class="pillDot"></span> Patreon: â€”
            </span>

            <button id="infoBtn" class="infoBtn" type="button" aria-label="Patreon credits info">i</button>
          </div>
        </div>
      </div>
    </div>

    <div id="infoPop" class="infoPop" aria-hidden="true">
      <div class="infoPopInner" role="dialog" aria-modal="false">
        <div class="infoPopTitle">Patreon credits info</div>
        <div id="infoPopBody" class="infoPopBody">
          Your current Patreon status: â€”<br>
          If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.
        </div>
        <button id="infoClose" class="infoClose" type="button">Close</button>
      </div>
    </div>

    <h2 style="margin: 18px 0 10px;">Rewards Store</h2>
    <div id="store" class="storeGrid"></div>

    <h2 style="margin: 22px 0 10px;">Your Unlocks</h2>
    <div id="unlocks" class="muted">Redeem something to see it here.</div>

    <footer>
      <div class="hangout">
        Want to hang out? Join the
        <a href="https://discord.com/invite/4Pyb5SQTdn" target="_blank" rel="noopener" style="color:var(--brand); font-weight:900;">Discord</a>
        or follow us on your favourite platform below ðŸ’›
      </div>

      <div class="footerInner">
        <div>Â© <span id="year"></span> Anya &amp; Lolo</div>

        <div class="socialText" aria-label="Social links">
          <a href="https://www.youtube.com/@Anya_and_Lolo" target="_blank" rel="noopener">YouTube</a>
          <a href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Itch</a>
          <a href="https://www.patreon.com/anya_and_lolo" target="_blank" rel="noopener">Patreon</a>

          <span class="sepDot"></span>

          <a href="https://www.instagram.com/anya_and_lolo" target="_blank" rel="noopener">Insta</a>
          <a href="https://tiktok.com/@anya_and_lolo" target="_blank" rel="noopener">TikTok</a>
          <a href="https://www.facebook.com/316257814895497" target="_blank" rel="noopener">Facebook</a>

          <span class="sepDot"></span>

          <a href="https://bsky.app/profile/anya-and-lolo.itch.io" target="_blank" rel="noopener">Bluesky</a>
          <a href="https://x.com/Anya_and_Lolo" target="_blank" rel="noopener">X</a>

          <span class="sepDot"></span>

          <a href="https://www.pixiv.net/en/users/105118068" target="_blank" rel="noopener">Pixiv</a>
          <a href="https://anya-and-lolo.booth.pm/" target="_blank" rel="noopener">Booth</a>
        </div>

        <div class="footerRight">
          <a href="./terms.html">Terms</a>
          <span class="sep">|</span>
          <a href="./privacy.html">Privacy</a>
        </div>
      </div>
    </footer>
  </main>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const API = "https://patreon-redeem-api.lady-anya.workers.dev";
    let CURRENT_CREDITS = 0;

    const ITEM_IMAGES = {
      fishing_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/fishing_system_image.jpg",
      visual_novel_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/VN_system_image.jpg",
      shooting_system: "https://raw.githubusercontent.com/Anya-and-Lolo/anya-and-lolo.github.io/refs/heads/main/images/shooting_system_image.jpg",
    };

    document.getElementById("connect").onclick = () => {
      location.href = API + "/auth/patreon/start";
    };

    const params = new URLSearchParams(location.search);
    const session = params.get("session");
    if (session) localStorage.setItem("session", session);

    function getSession() {
      return localStorage.getItem("session");
    }

    function showStoreMessage(buttonEl, msg, type = "info") {
      if (!buttonEl) return;
    
      const card = buttonEl.closest(".card");
      if (!card) return;
    
      const box = card.querySelector(".storeMsg");
      if (!box) return;
    
      // Grab the default blue text (stored on the storeMsg element)
      const defaultMsg = box.dataset.defaultMsg || box.textContent;
    
      // Save it once (first time)
      if (!box.dataset.defaultMsg) box.dataset.defaultMsg = defaultMsg;
    
      // Clear any previous timer
      clearTimeout(box._resetTimer);
    
      // Apply styles + message
      box.classList.remove("storeMsg--success","storeMsg--error","storeMsg--info","show");
      box.classList.add("show");
      if (type === "success") box.classList.add("storeMsg--success");
      else if (type === "error") box.classList.add("storeMsg--error");
      else box.classList.add("storeMsg--info");
    
      box.textContent = msg;
    
      // Auto-revert after 5s (only for error/success)
      if (type === "error" || type === "success") {
        box._resetTimer = setTimeout(() => {
          box.classList.remove("storeMsg--success","storeMsg--error");
          box.classList.add("storeMsg--info");
          box.textContent = box.dataset.defaultMsg || defaultMsg;
        }, 3000);
      }
    }

    function isProbablyUrl(s) {
      return typeof s === "string" && /^https?:\/\//i.test(s.trim());
    }

    function setPill(status){
      const pill = document.getElementById("patreonPill");
      if (!pill) return;

      const s = String(status || "").toLowerCase();

      let cls = "pill--gray";
      if (s.includes("active")) cls = "pill--green";
      else if (s.includes("declined")) cls = "pill--red";
      else if (s.includes("paused") || s.includes("pending")) cls = "pill--amber";
      else if (s.includes("former") || s.includes("canceled") || s.includes("cancelled")) cls = "pill--gray";

      pill.classList.remove("pill--green","pill--amber","pill--red","pill--gray");
      pill.classList.add(cls);
      pill.innerHTML = `<span class="pillDot"></span> Patreon: ${status ?? "unknown"}`;
    }

    async function loadMe() {
      const s = getSession();
      const btn = document.getElementById("connect");
      const creditsValue = document.getElementById("creditsValue");
      const infoPopBody = document.getElementById("infoPopBody");

      // âœ… Not connected
      if (!s) {
        if (creditsValue) creditsValue.textContent = "not connected";
        CURRENT_CREDITS = 0;

        if (btn) { btn.textContent = "Connect Patreon"; btn.disabled = false; }
        setPill("not connected");

        if (infoPopBody) {
          infoPopBody.innerHTML =
            `Your current Patreon status: <strong>not connected</strong><br>` +
            `If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.`;
        }
        return null;
      }

      // âœ… Connected: fetch /me
      let me;
      try{
        const r = await fetch(API + "/me?session=" + encodeURIComponent(s));
        me = await r.json();
      }catch(e){
        if (creditsValue) creditsValue.textContent = "error";
        CURRENT_CREDITS = 0;
        if (btn) { btn.textContent = "Connect Patreon"; btn.disabled = false; }
        setPill("error");
        if (infoPopBody) {
          infoPopBody.innerHTML =
            `Your current Patreon status: <strong>error</strong><br>` +
            `Couldnâ€™t load your Patreon info right now. Please try again in a moment.`;
        }
        return null;
      }

      if (!me.loggedIn) {
        if (creditsValue) creditsValue.textContent = "not connected";
        CURRENT_CREDITS = 0;
        if (btn) { btn.textContent = "Connect Patreon"; btn.disabled = false; }
        setPill("not connected");
        if (infoPopBody) {
          infoPopBody.innerHTML =
            `Your current Patreon status: <strong>not connected</strong><br>` +
            `If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.`;
        }
        return null;
      }

      // âœ… Logged in
      const credits = Number(me.credits ?? 0);
      CURRENT_CREDITS = credits;
      if (creditsValue) creditsValue.textContent = String(credits.toFixed(2));

      if (btn) {
        btn.textContent = "Connected âœ…";
        btn.disabled = true;
      }

      const status = me.patreon_status || "active (connected)";
      setPill(status);

      if (infoPopBody) {
        infoPopBody.innerHTML =
          `Your current Patreon status: <strong>${status}</strong><br>` +
          `If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.`;
      }

      return me;
    }

    const redeeming = new Set();

async function loadStore() {
  const r = await fetch(API + "/store");
  const data = await r.json();
  const el = document.getElementById("store");
  el.innerHTML = "";

  (data.items || []).forEach(item => {
    const credits = (item.cost_cents / 100).toFixed(2);
    const remaining = item.remaining ?? 0;
    const img = ITEM_IMAGES[item.id] || "";

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      ${img ? `<img class="storeImg" src="${img}" alt="${item.name}">` : ""}

      <div style="margin-top:10px;">
        <strong>${item.name}</strong><br>
        <span class="muted">${credits} credits â€¢ Remaining keys: ${remaining}</span>
      </div>

      <button
        class="storeButton"
        ${remaining <= 0 ? "disabled" : ""}
        data-id="${item.id}"
        data-name="${item.name}"
        data-cost-cents="${item.cost_cents}">
        Redeem
      </button>

      <!-- Inline message area (replaces toast) -->
      <div class="storeMsg storeMsg--info show">
        ${item.payload?.instructions || "Redeem to receive a unique itch.io key. Open the link below to claim it on itch.io and permanently add it to your library."}
      </div>
    `;

    const btn = div.querySelector("button");
    btn.onclick = () => redeem(item.id, btn);

    el.appendChild(div);
  });
}

    async function loadUnlocks() {
      const s = getSession();
      const box = document.getElementById("unlocks");

      if (!s) {
        box.classList.add("muted");
        box.textContent = "Connect Patreon to see your unlocks.";
        return;
      }

      const r = await fetch(API + "/entitlements?session=" + encodeURIComponent(s));
      const data = await r.json();

      if (!r.ok) {
        box.classList.add("muted");
        box.textContent = data.error || "Could not load unlocks.";
        return;
      }

      if (!data.items || data.items.length === 0) {
        box.classList.add("muted");
        box.textContent = "Redeem something to see it here.";
        return;
      }

      box.classList.remove("muted");
      box.innerHTML = "";

      data.items.forEach(ent => {
        const title = ent.payload?.title || ent.item_id;
        const raw = ent.payload?.itch_key_url || ent.payload?.itch_key || ent.payload?.url || "";
        addUnlock(title, raw);
      });
    }

    function addUnlock(title, rawKeyOrUrl) {
      const box = document.getElementById("unlocks");
      if (box.classList.contains("muted")) box.classList.remove("muted");

      const isUrl = isProbablyUrl(rawKeyOrUrl);
      const keyLabel = isUrl ? "Your itch.io key link:" : "Your itch.io key code:";
      const openHref = isUrl ? rawKeyOrUrl : "https://itch.io/claim";
      const openText = isUrl ? "Open key â†’" : "Open itch.io claim â†’";

      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <strong>${title}</strong>
        <div class="keybox" style="margin-top:8px">
          <div>${keyLabel}</div>
          <div><code class="key">${rawKeyOrUrl || "(missing key)"}</code></div>
          <div style="margin-top:8px" class="row">
            <button class="copy">Copy</button>
            <a class="open" href="${openHref}" target="_blank" rel="noopener">${openText}</a>
          </div>
          <div class="muted" style="margin-top:8px">
            ðŸ’› Thank you for supporting Anya & Lolo! Please donâ€™t share your key.
          </div>
        </div>
      `;

      wrap.querySelector(".copy").onclick = async () => {
        await navigator.clipboard.writeText(rawKeyOrUrl || "");
        const msg = wrap.querySelector(".copiedMsg") || (() => {
          const m = document.createElement("div");
          m.className = "muted copiedMsg";
          m.style.marginTop = "8px";
          m.textContent = "Copied! ðŸ’›";
          wrap.querySelector(".keybox")?.appendChild(m);
          return m;
        })();
        msg.textContent = "Copied! ðŸ’›";
      };

      box.prepend(wrap);
    }

    // âœ… Redeem with client-side credits check + nice toasts
async function redeem(itemId, buttonEl) {
  const s = getSession();
  if (!s) {
    showStoreMessage(buttonEl, "Please connect Patreon first.", "error");
    return;
  }

  const costCents = Number(buttonEl?.dataset?.costCents ?? 0);
  const costCredits = Number((costCents / 100).toFixed(2));
  const itemName = buttonEl?.dataset?.name || itemId;

  // Friendly client-side check
  if (CURRENT_CREDITS < costCredits) {
    showStoreMessage(
      buttonEl,
      `Sorry, you have ${CURRENT_CREDITS.toFixed(2)} credits, but need ${costCredits.toFixed(2)} credits for ${itemName}.`,
      "error"
    );
    return;
  }

  if (redeeming.has(itemId)) return;
  redeeming.add(itemId);

  const originalText = buttonEl ? buttonEl.textContent : "";
  if (buttonEl) {
    buttonEl.disabled = true;
    buttonEl.textContent = "Redeemingâ€¦";
  }

  // show progress inline
  showStoreMessage(buttonEl, `Redeeming ${itemName}â€¦`, "info");

  try {
    const r = await fetch(API + "/redeem?session=" + encodeURIComponent(s), {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ itemId })
    });

    const out = await r.json();

    if (!r.ok) {
      showStoreMessage(buttonEl, out.error || "Redeem failed. Please try again.", "error");
      return;
    }

    const raw = out.payload?.itch_key_url || out.payload?.itch_key || out.payload?.url || "";
    if (raw) {
      addUnlock(out.item?.name || itemId, raw);
      showStoreMessage(buttonEl, `ðŸŽ‰ Success! ${itemName} unlocked. Your key is now in â€œYour Unlocksâ€.`, "success");
    } else {
      showStoreMessage(buttonEl, "âœ… Redeemed! (No key returned)", "success");
    }

    await loadMe();
    await loadStore();
    await loadUnlocks();

  } finally {
    redeeming.delete(itemId);
    if (buttonEl) {
      buttonEl.disabled = false;
      buttonEl.textContent = originalText || "Redeem";
    }
  }
}

    // Info popup wiring
    const infoBtn = document.getElementById("infoBtn");
    const infoPop = document.getElementById("infoPop");
    const infoClose = document.getElementById("infoClose");

    function openInfo(){
      if (!infoPop) return;
      infoPop.classList.add("show");
      infoPop.setAttribute("aria-hidden", "false");
    }
    function closeInfo(){
      if (!infoPop) return;
      infoPop.classList.remove("show");
      infoPop.setAttribute("aria-hidden", "true");
    }

    infoBtn?.addEventListener("click", () => {
      if (!infoPop) return;
      const isOpen = infoPop.classList.contains("show");
      if (isOpen) closeInfo();
      else openInfo();
    });

    infoClose?.addEventListener("click", closeInfo);

    infoPop?.addEventListener("click", (e) => {
      if (e.target === infoPop) closeInfo();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeInfo();
    });

    (async () => {
      await loadMe();
      await loadStore();
      await loadUnlocks();
    })();
  </script>

<script>
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) e.target.classList.add("reveal");
    });
  }, { threshold: 0.12 });

  document.querySelectorAll(".card").forEach(c => {
    c.classList.add("preReveal");
    io.observe(c);
  });
</script>

<style>
.preReveal{
  opacity: 0;
  transform: translateY(10px);
  transition: opacity .45s ease, transform .45s ease;
}
.reveal{
  opacity: 1;
  transform: translateY(0);
}
</style>
  
<script>
  document.querySelectorAll('a[href*="itch.io"]').forEach(el => {
    el.addEventListener("click", () => {
      el.classList.remove("pop");
      void el.offsetWidth; // restart animation
      el.classList.add("pop");
    });
  });
</script>

<script src="https://app.embed.im/confetti.js" defer></script>
<script src="https://app.embed.im/sparkles.js" defer></script>

</body>
</html>























