<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patreon Rewards â€¢ Anya & Lolo</title>
  <meta name="description" content="Connect Patreon, view credits, and redeem itch.io keys for Anya & Lolo rewards." />

  <style>
    :root{
      --brand: #f4184c;
      --brand2: rgba(244, 24, 76, 0.12);

      --bg: #ffffff;
      --card: rgba(255,255,255,0.88);
      --border: rgba(20,20,20,0.10);
      --text: #1b1b1b;
      --muted: rgba(27,27,27,0.70);

      --radius: 16px;
      --shadow: 0 10px 28px rgba(0,0,0,.10);
    }

    *{ box-sizing: border-box; }
    html, body{
      height: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
      font-size: 17px;
      line-height: 1.6;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      opacity: 1;
      background:
        radial-gradient(circle, rgba(244,24,76,0.22) 2px, transparent 3.5px) 0 0/42px 42px,
        radial-gradient(circle, rgba(86,167,254,0.20) 2px, transparent 3.5px) 21px 21px/42px 42px;
      animation: dotsFloat 22s linear infinite;
    }
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(255, 250, 252, 0.45);
    }
    @keyframes dotsFloat{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(-120px, -90px, 0); }
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; text-underline-offset: 4px; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    button, .navlink, a{
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    button:active, .navlink:active{
      transform: translateY(1px) scale(0.99);
    }

    .btnPrimary:hover{
      box-shadow: 0 14px 30px rgba(244,24,76,.20);
      transform: translateY(-1px);
    }

    a.pop{ animation: pop .28s ease; }
    @keyframes pop{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.04); }
      100%{ transform: scale(1); }
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.72);
      border-bottom: 1px solid var(--border);
    }

    .topbarInner{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }

    .badge{
      font-size: 14px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.85);
      color: var(--muted);
      font-weight: 900;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content: flex-end;
    }

    .navlink{
      display:inline-flex;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 15px;
      color: rgba(27,27,27,0.88);
      text-decoration: none;
      border: 1px solid transparent;
      background: transparent;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .navlink:hover{
      text-decoration: none;
      background: rgba(0,0,0,0.06);
      transform: translateY(-1px);
    }

    .navlink:active{
      transform: translateY(0px) scale(0.99);
    }

    .topbar .navlink[aria-current="page"]{
      background: var(--brand2);
      color: var(--brand);
      border-color: rgba(244,24,76,0.25);
    }

    @media (max-width: 600px){
      .topbarInner{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      nav{
        justify-content: flex-start;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding: 2px 2px 4px;
        scroll-snap-type: x mandatory;
      }
      nav::-webkit-scrollbar{ display:none; }

      .navlink{
        flex: 0 0 auto;
        white-space: nowrap;
        scroll-snap-align: start;
        background: rgba(255,255,255,0.90);
        border-color: rgba(20,20,20,0.12);
      }

      nav{
        -webkit-mask-image: linear-gradient(to right,
          transparent 0,
          #000 16px,
          #000 calc(100% - 16px),
          transparent 100%
        );
                mask-image: linear-gradient(to right,
          transparent 0,
          #000 16px,
          #000 calc(100% - 16px),
          transparent 100%
        );
      }

      .price{
        font-size: 16px;  
        font-weight: 1000; 
        color: rgba(27,27,27,0.88);
      }

      .badge{
        font-size: 13px;
        padding: 6px 10px;
      }
    }

    h1{
      margin: 14px 0 6px;
      font-size: 34px;
      letter-spacing: -0.5px;
      line-height: 1.15;
    }
    .sub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 16px;
    }

    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
      font-weight: 900;
    }
    button:disabled{ opacity: .6; cursor: not-allowed; }

    .btnPrimary{
      background: var(--brand);
      color: #fff;
      border-color: rgba(244,24,76,0.35);
    }

    .card{
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      margin: 12px 0;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    code{ font-size: 14px; }
    .muted{ color: rgba(27,27,27,0.70); font-size: 13px; }

    .keybox{
      background:#fff;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(20,20,20,0.18);
    }

    .storeGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .storeImg{
      width: 100%;
      height: 240px;
      object-fit: contain;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(20,20,20,0.08);
    }

    .storeButton{
      margin-top: 10px;
      width: 100%;
    }

    footer{
      margin-top: 26px;
      padding: 18px 0 34px;
      color: rgba(27,27,27,0.72);
      font-size: 14px;
    }

    .creditsLine{
      font-size: 14px;
      color: rgba(27,27,27,0.80);
      font-weight: 800;
    }
    .creditsLine strong{
      font-size: 16px;
      font-weight: 1000;
    }

    .patreonRow{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 8px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      font-size: 13px;
      color: #333;
    }
    .pillDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
    }

    .pill--blue .pillDot{ background:#56a7fe; }
    .pill--green .pillDot{ background:#22c55e; }
    .pill--amber .pillDot{ background:#f59e0b; }
    .pill--red   .pillDot{ background:#ef4444; }
    .pill--gray  .pillDot{ background:#9ca3af; }

    .infoBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .infoBtn:hover{ background: rgba(0,0,0,0.06); }

    .infoPop{
      position: fixed;
      inset: 0;
      display:none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
      background: rgba(0,0,0,0.18);
    }
    .infoPop.show{ display:flex; }

    .infoPopInner{
      width: min(520px, 100%);
      background: #fff;
      border: 1px solid rgba(20,20,20,0.14);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
    }
    .infoPopTitle{ font-weight: 1000; margin-bottom: 8px; }
    .infoPopBody{ font-size: 14px; color: #333; line-height: 1.5; }

    .infoClose{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .hangout{
      text-align: center;
      margin: 18px 0 14px;
      font-size: 15px;
      color: rgba(27,27,27,0.78);
    }

    /* Desktop: keep it on the right */
    .statusBlock{
      text-align: right;
    }
    
    /* Mobile: stack nicely under the button */
    @media (max-width: 600px){
      .row{ align-items: flex-start; }
    
      .statusBlock{
        width: 100%;
        text-align: center;
      }
    
      /* Optional: make button full width so it feels tidy */
      #connect{ width: 100%; }
    
      .patreonRow{
        justify-content: center;
      }
    }
    
    .storeMsg{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.12);
      background: rgba(255,255,255,0.9);
      font-size: 13px;
      color: rgba(27,27,27,0.86);
      display: none;
    }
    .storeMsg.show{ display: block; }

    .storeMsg--success{
      border-color: rgba(34,197,94,0.30);
      background: rgba(34,197,94,0.10);
    }
    .storeMsg--error{
      border-color: rgba(239,68,68,0.30);
      background: rgba(239,68,68,0.10);
    }
    .storeMsg--info{
      border-color: rgba(86,167,254,0.30);
      background: rgba(86,167,254,0.10);
    }

    .footerInner{
      border-top: 1px solid var(--border);
      padding-top: 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items:center;
    }

    .socialText{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:center;
      align-items:center;
      font-weight: 900;
    }

    .socialText a{
      padding: 2px 6px;
      border-radius: 10px;
      text-decoration: none;
    }
    .socialText a:hover{
      background: rgba(0,0,0,0.06);
      text-decoration: none;
    }

    .sepDot{
      width: 6px;
      height: 6px;
      background: var(--brand);
      border-radius: 50%;
      display: inline-block;
      margin: 0 10px;
    }

    .footerRight{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .sep{
      color: rgba(20,20,20,0.35);
      font-weight: 800;
      margin: 0 2px;
    }

    @media (max-width: 900px){
      html, body{ height: auto; }
      .topbarInner{ align-items: flex-start; flex-direction: column; align-items: center;}
      nav{ justify-content: flex-start; }
      .footerInner{ grid-template-columns: 1fr; text-align:center; }
      .footerRight{ justify-content: center !important; }
      .socialText{ justify-content: center !important; }
    }

    canvas,
    #sparkles,
    .sparkles,
    .sparkle-canvas,
    [class*="sparkle"]{
      pointer-events: none !important;
      touch-action: none !important;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <span class="badge">RPG Maker Systems â€¢ Mechanics â€¢ Game Development</span>
      </div>

      <nav aria-label="Primary">
        <a class="navlink" href="./">Home</a>
        <a class="navlink" href="./redeem.html" aria-current="page">Rewards</a>
        <a class="navlink" href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Smart Systems</a>
        <a class="navlink" href="https://anyalolo.substack.com/" target="_blank" rel="noopener">Our Blog</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Patreon Rewards</h1>
    <p class="sub">Connect Patreon, view credits, and redeem your itch.io keys for Anya & Lolo rewards.</p>

    <div class="card" style="margin: 10px 0 14px;">
      <div class="row">
        <button id="connect" class="btnPrimary">Connect Patreon</button>

        <div class="statusBlock">  
          <div class="creditsLine">
            My Credits: <strong id="creditsValue">N/A</strong> (1Â¢ = 1 credit)
          </div>
        
          <div class="patreonRow">
            <span id="patreonPill" class="pill pill--gray">
              <span class="pillDot"></span> Patreon: not connected
            </span>
        
            <button id="infoBtn" class="infoBtn" type="button" aria-label="Patreon credits info">i</button>
          </div>
        </div>
      </div>
    </div>

    <div id="infoPop" class="infoPop" aria-hidden="true">
      <div class="infoPopInner" role="dialog" aria-modal="false">
        <div class="infoPopTitle">Patreon credits info</div>
        <div id="infoPopBody" class="infoPopBody">
          Your current Patreon status: â€”<br>
          If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.
        </div>
        <button id="infoClose" class="infoClose" type="button">Close</button>
        <button id="copySupport" class="infoClose" type="button">Copy Support Info</button>
        <div class="muted" id="supportCopied" style="margin-top:8px;"></div>
      </div>
    </div>

    <h2 style="margin: 18px 0 10px;">Rewards Store</h2>
    <div id="store" class="storeGrid"></div>

    <h2 style="margin: 22px 0 10px;">Your Unlocks</h2>
    <div id="unlocks" class="muted">Redeem something to see it here.</div>

    <footer>
      <div class="hangout">
        Want to hang out? Join the
        <a href="https://discord.com/invite/4Pyb5SQTdn" target="_blank" rel="noopener" style="color:var(--brand); font-weight:900;">Discord</a>
        or follow us on your favourite platform below ðŸ’›
      </div>

      <div class="footerInner">
        <div>Â© <span id="year"></span> Anya &amp; Lolo</div>

        <div class="socialText" aria-label="Social links">
          <a href="https://www.youtube.com/@Anya_and_Lolo" target="_blank" rel="noopener">YouTube</a>
          <a href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Itch</a>
          <a href="https://www.patreon.com/anya_and_lolo" target="_blank" rel="noopener">Patreon</a>

          <span class="sepDot"></span>

          <a href="https://www.instagram.com/anya_and_lolo" target="_blank" rel="noopener">Insta</a>
          <a href="https://tiktok.com/@anya_and_lolo" target="_blank" rel="noopener">TikTok</a>
          <a href="https://www.facebook.com/316257814895497" target="_blank" rel="noopener">Facebook</a>

          <span class="sepDot"></span>

          <a href="https://bsky.app/profile/anya-and-lolo.itch.io" target="_blank" rel="noopener">Bluesky</a>
          <a href="https://x.com/Anya_and_Lolo" target="_blank" rel="noopener">X</a>

          <span class="sepDot"></span>

          <a href="https://www.pixiv.net/en/users/105118068" target="_blank" rel="noopener">Pixiv</a>
          <a href="https://anya-and-lolo.booth.pm/" target="_blank" rel="noopener">Booth</a>
        </div>

        <div class="footerRight">
          <a href="./terms.html">Terms</a>
          <span class="sep">|</span>
          <a href="./privacy.html">Privacy</a>
        </div>
      </div>
    </footer>
  </main>

<script>
  let LAST_LOOKUP_PATREON_ID = "";

  function apiBase() {
    return document.getElementById("apiBase").value.trim().replace(/\/+$/, "");
  }

  function token() {
    return document.getElementById("adminToken").value.trim();
  }

  function authHeaders() {
    const t = token();
    if (!t) return null;
    return { "Authorization": "Bearer " + t };
  }

  function setJson(el, obj) {
    el.textContent = JSON.stringify(obj, null, 2);
  }

  function updateAuthPill() {
    const pill = document.getElementById("authPill");
    const has = !!token();
    pill.className = "pill " + (has ? "ok" : "info");
    pill.innerHTML = `<span class="dot"></span><span>Token: ${has ? "set" : "not set"}</span>`;
  }

  document.getElementById("adminToken").addEventListener("input", updateAuthPill);
  updateAuthPill();

  document.getElementById("toggleToken").onclick = () => {
    const i = document.getElementById("adminToken");
    i.type = (i.type === "password") ? "text" : "password";
    document.getElementById("toggleToken").textContent = (i.type === "password") ? "Show" : "Hide";
  };

  async function callJson(path, { method="GET", body=null, query=null, confirmText=null } = {}) {
    const out = document.getElementById("out");
    const lastReq = document.getElementById("lastReq");

    const auth = authHeaders();
    if (!auth) {
      setJson(out, { error: "missing ADMIN_TOKEN" });
      return null;
    }

    if (confirmText) {
      const ok = confirm(confirmText);
      if (!ok) return null;
    }

    let url = apiBase() + path;
    if (query && typeof query === "object") {
      const u = new URL(url);
      for (const [k,v] of Object.entries(query)) u.searchParams.set(k, v);
      url = u.toString();
    }

    const headers = { ...auth };
    if (body) headers["content-type"] = "application/json";

    setJson(lastReq, {
      url,
      method,
      headers: { Authorization: "Bearer ***" },
      body
    });

    try {
      const r = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });

      const j = await r.json().catch(() => ({}));
      const payload = { http: r.status, ...j };
      setJson(out, payload);
      return { ok: r.ok, status: r.status, json: payload };
    } catch (e) {
      setJson(out, { error: String(e) });
      return null;
    }
  }

  async function refreshCurrentUser() {
    if (!LAST_LOOKUP_PATREON_ID) return;
    const res = await callJson("/admin/user", { query: { patreon_user_id: LAST_LOOKUP_PATREON_ID } });
    if (res?.ok) renderUserSummary(res.json);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderUserSummary(data){
    const box = document.getElementById("userSummary");

    if (!data || !data.userId) {
      box.className = "muted";
      box.textContent = "No user loaded yet.";
      return;
    }

    const userId = data.userId;
    const patreonId = data.link?.patreon_user_id || "";
    const expires = data.link?.token_expires_at ? new Date(data.link.token_expires_at * 1000).toISOString() : "";
    const ent = Array.isArray(data.entitlements) ? data.entitlements : [];

    const entHtml = ent.length ? ent.map(e => {
      const entId = e.id || "";
      const itemId = e.item_id || "";
      const title = e.payload?.title || itemId || "Untitled";
      const claimedAt = e.payload?.claimed_at || "";
      const keyCode = e.payload?.itch_key_code || "";
      const keyUrl = e.payload?.itch_key_url || "";

      return `
        <div class="entCard">
          <div class="entTop">
            <div>
              <div class="entTitle">${escapeHtml(title)}</div>
              <div class="entMeta">item_id: ${escapeHtml(itemId)}</div>
            </div>
            <div class="entActions">
              ${keyUrl ? `<a class="smallBtn linkBtn btnGhost" href="${escapeHtml(keyUrl)}" target="_blank" rel="noopener">Open key</a>` : ""}
              <button class="smallBtn btnPrimary" data-act="reissue" data-user="${escapeHtml(userId)}" data-item="${escapeHtml(itemId)}">Reissue</button>
              <button class="smallBtn btnDanger" data-act="deleteById" data-ent="${escapeHtml(entId)}">Delete</button>
            </div>
          </div>

          <div class="kv">
            <div class="k">entitlement_id</div><div class="v">${escapeHtml(entId)}</div>
            <div class="k">key_code</div><div class="v">${escapeHtml(keyCode || "(none)")}</div>
            <div class="k">claimed_at</div><div class="v">${escapeHtml(claimedAt || "(not set)")}</div>
          </div>
        </div>
      `;
    }).join("") : `<div class="muted" style="margin-top:10px;">No entitlements found.</div>`;

    box.className = "";
    box.innerHTML = `
      <div class="kv">
        <div class="k">user_id</div><div class="v">${escapeHtml(userId)}</div>
        <div class="k">patreon_user_id</div><div class="v">${escapeHtml(patreonId || "(unknown)")}</div>
        <div class="k">token_expires_at</div><div class="v">${escapeHtml(expires || "(unknown)")}</div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 6px;">Entitlements (${ent.length})</h3>
      <div class="entList">${entHtml}</div>
    `;

    // wire entitlement buttons + AUTO-REFRESH
    box.querySelectorAll("button[data-act='reissue']").forEach(btn => {
      btn.onclick = async () => {
        const user_id = btn.getAttribute("data-user");
        const item_id = btn.getAttribute("data-item");
        const res = await callJson("/admin/keys/reissue", {
          method:"POST",
          body:{ user_id, item_id },
          confirmText:`Reissue key for ${user_id} / ${item_id}?\nThis may burn a key.`
        });
        if (res?.ok) await refreshCurrentUser();
      };
    });

    box.querySelectorAll("button[data-act='deleteById']").forEach(btn => {
      btn.onclick = async () => {
        const entitlement_id = btn.getAttribute("data-ent");
        const res = await callJson("/admin/entitlements/delete", {
          method:"POST",
          body:{ entitlement_id },
          confirmText:`DELETE entitlement ${entitlement_id}?\nThis cannot be undone.`
        });
        if (res?.ok) await refreshCurrentUser();
      };
    });
  }

  // Ping
  document.getElementById("ping").onclick = () => callJson("/admin/ping");

  // Lookup user
  document.getElementById("lookup").onclick = async () => {
    const id = document.getElementById("patreonUserId").value.trim();
    if (!id) return setJson(document.getElementById("out"), { error: "missing patreon_user_id" });

    LAST_LOOKUP_PATREON_ID = id;

    const res = await callJson("/admin/user", { query: { patreon_user_id: id } });
    if (res?.ok) renderUserSummary(res.json);
  };

  // Credits add/remove (AUTO-REFRESH)
  document.getElementById("creditsAdd").onclick = async () => {
    const user_id = document.getElementById("creditUserId").value.trim();
    const delta_cents = Number(document.getElementById("deltaCents").value);
    const note = document.getElementById("creditNote").value.trim();
    if (!user_id) return setJson(document.getElementById("out"), { error: "missing user_id" });
    if (!Number.isFinite(delta_cents)) return setJson(document.getElementById("out"), { error: "delta_cents must be a number" });

    const res = await callJson("/admin/credits/add", { method:"POST", body:{ user_id, delta_cents, note }});
    if (res?.ok) await refreshCurrentUser();
  };

  // Credits set exact (AUTO-REFRESH)
  document.getElementById("creditsSet").onclick = async () => {
    const user_id = document.getElementById("setCreditUserId").value.trim();
    const target_available_cents = Number(document.getElementById("targetCents").value);
    const note = document.getElementById("setCreditNote").value.trim();
    if (!user_id) return setJson(document.getElementById("out"), { error: "missing user_id" });
    if (!Number.isFinite(target_available_cents)) return setJson(document.getElementById("out"), { error: "target_available_cents must be a number" });

    const res = await callJson("/admin/credits/set", {
      method:"POST",
      body:{ user_id, target_available_cents, note },
      confirmText: `Set credits for ${user_id} to ${target_available_cents}?`
    });
    if (res?.ok) await refreshCurrentUser();
  };

  // Add entitlement (AUTO-REFRESH)
  document.getElementById("entAdd").onclick = async () => {
    const user_id = document.getElementById("entAddUserId").value.trim();
    const item_id = document.getElementById("entAddItemId").value.trim();
    const raw = document.getElementById("entAddPayload").value.trim();

    if (!user_id || !item_id) return setJson(document.getElementById("out"), { error: "missing user_id or item_id" });

    let payload = undefined;
    if (raw) {
      try { payload = JSON.parse(raw); }
      catch { return setJson(document.getElementById("out"), { error: "payload must be valid JSON" }); }
    }

    const res = await callJson("/admin/entitlements/add", { method:"POST", body:{ user_id, item_id, payload }});
    if (res?.ok) await refreshCurrentUser();
  };

  // Delete entitlement by ID (AUTO-REFRESH)
  document.getElementById("entDelById").onclick = async () => {
    const entitlement_id = document.getElementById("entDelId").value.trim();
    if (!entitlement_id) return setJson(document.getElementById("out"), { error: "missing entitlement_id" });

    const res = await callJson("/admin/entitlements/delete", {
      method:"POST",
      body:{ entitlement_id },
      confirmText:`DELETE entitlement ${entitlement_id}?\nThis cannot be undone.`
    });
    if (res?.ok) await refreshCurrentUser();
  };

  // Delete entitlement by user+item (AUTO-REFRESH)
  document.getElementById("entDelByUserItem").onclick = async () => {
    const user_id = document.getElementById("entDelUserId").value.trim();
    const item_id = document.getElementById("entDelItemId").value.trim();
    if (!user_id || !item_id) return setJson(document.getElementById("out"), { error: "missing user_id or item_id" });

    const res = await callJson("/admin/entitlements/delete", {
      method:"POST",
      body:{ user_id, item_id },
      confirmText:`DELETE entitlement for ${user_id} / ${item_id}?\nThis cannot be undone.`
    });
    if (res?.ok) await refreshCurrentUser();
  };

  // Reissue key (AUTO-REFRESH)
  document.getElementById("reissue").onclick = async () => {
    const user_id = document.getElementById("reissueUserId").value.trim();
    const item_id = document.getElementById("reissueItemId").value.trim();
    if (!user_id || !item_id) return setJson(document.getElementById("out"), { error: "missing user_id or item_id" });

    const res = await callJson("/admin/keys/reissue", {
      method:"POST",
      body:{ user_id, item_id },
      confirmText:`Reissue key for ${user_id} / ${item_id}?\nThis may burn a key.`
    });
    if (res?.ok) await refreshCurrentUser();
  };

  // Migrate (AUTO-REFRESH)
  document.getElementById("migrate").onclick = async () => {
    const fromUserId = document.getElementById("fromUserId").value.trim();
    const toUserId = document.getElementById("toUserId").value.trim();
    if (!fromUserId || !toUserId) return setJson(document.getElementById("out"), { error: "missing from/to" });

    const res = await callJson("/admin/migrate", {
      method:"POST",
      body:{ fromUserId, toUserId },
      confirmText:`Migrate ALL entitlements from:\n${fromUserId}\nâ†’ ${toUserId}\nProceed?`
    });
    if (res?.ok) await refreshCurrentUser();
  };

  // Console actions
  document.getElementById("clearOut").onclick = () => {
    setJson(document.getElementById("out"), {});
    setJson(document.getElementById("lastReq"), {});
    LAST_LOOKUP_PATREON_ID = "";
    const us = document.getElementById("userSummary");
    us.className = "muted";
    us.textContent = "No user loaded yet.";
  };

  document.getElementById("copyOut").onclick = async () => {
    const txt = document.getElementById("out").textContent || "{}";
    await navigator.clipboard.writeText(txt);
  };
</script>

  <script src="https://app.embed.im/confetti.js" defer></script>
</body>
</html>












