<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patreon Rewards & Key Redeem | Anya & Lolo</title>
<meta name="description" content="Connect Patreon to view your credits and redeem itch.io keys for Anya & Lolo rewards and RPG Maker systems." />
<link rel="canonical" href="https://anya-and-lolo.github.io/redeem.html" />

<meta property="og:type" content="website" />
<meta property="og:site_name" content="Anya & Lolo" />
<meta property="og:title" content="Patreon Rewards & Key Redeem | Anya & Lolo" />
<meta property="og:description" content="Connect Patreon to view your credits and redeem itch.io keys for Anya & Lolo rewards and RPG Maker systems." />
<meta property="og:url" content="https://anya-and-lolo.github.io/redeem.html" />
<meta property="og:image" content="https://anya-and-lolo.github.io/images/banner.jpg" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@Anya_and_Lolo" />
<meta name="twitter:title" content="Patreon Rewards & Key Redeem | Anya & Lolo" />
<meta name="twitter:description" content="Connect Patreon to view your credits and redeem itch.io keys for Anya & Lolo rewards and RPG Maker systems." />
<meta name="twitter:image" content="https://anya-and-lolo.github.io/images/banner.jpg" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Patreon Rewards & Key Redeem",
  "url": "https://anya-and-lolo.github.io/redeem.html",
  "isPartOf": {
    "@type": "WebSite",
    "name": "Anya & Lolo",
    "url": "https://anya-and-lolo.github.io/"
  }
}
</script>

<style>
  /* THEME TOKENS */
  :root{
    --brand: #f4184c;
    --brand2: rgba(244, 24, 76, 0.12);

    --bg: #ffffff;
    --card: rgba(255,255,255,0.88);
    --border: rgba(20,20,20,0.10);
    --text: #1b1b1b;
    --muted: rgba(27,27,27,0.70);

    --radius: 16px;
    --shadow: 0 10px 28px rgba(0,0,0,.10);
  }

  /* BASE / RESET */
  *{ box-sizing: border-box; }

  html, body{
    height: auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  body{
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
    background: var(--bg);
    overflow-x: hidden;
    font-size: 17px;
    line-height: 1.6;
  }

  a{ color: inherit; text-decoration: none; }
  a:hover{ text-decoration: underline; text-underline-offset: 4px; }

  code{ font-size: 14px; }
  .muted{ color: rgba(27,27,27,0.70); font-size: 13px; }

  /* BACKGROUND DOTS */
  body::before{
    content:"";
    position: fixed;
    inset: 0;
    z-index: -2;
    opacity: 1;
    transform: translateZ(0);
    will-change: background-position;

    background:
      radial-gradient(circle, rgba(244,24,76,0.15) 2px, transparent 3.5px),
      radial-gradient(circle, rgba(86,167,254,0.12) 2px, transparent 3.5px);

    background-size: 42px 42px, 42px 42px;
    background-position: 0 0, 21px 21px;
    background-repeat: repeat, repeat;

    animation: dotsFloat 22s linear infinite;
  }

  @keyframes dotsFloat{
    from{ background-position: 0 0, 21px 21px; }
    to{ background-position: -168px -84px, -147px -63px; }
  }

  /* MICRO ANIM / INTERACTIONS */
  button, .navlink, a{
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  }

  button:active, .navlink:active{
    transform: translateY(1px) scale(0.99);
  }

  .btnPrimary:hover{
    box-shadow: 0 14px 30px rgba(244,24,76,.20);
    transform: translateY(-1px);
  }

  a.pop{ animation: pop .28s ease; }
  @keyframes pop{
    0%{ transform: scale(1); }
    45%{ transform: scale(1.04); }
    100%{ transform: scale(1); }
  }

  /* LAYOUT WRAPPER */
  .wrap{
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px;
  }

  /* TOP BAR / NAV */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.72);
    border-bottom: 1px solid var(--border);
  }

  .topbarInner{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 16px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap: 10px;
    white-space: nowrap;
  }

  .badge{
    font-size: 14px;
    padding: 7px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.85);
    color: var(--muted);
    font-weight: 900;
  }

  nav{
    display:flex;
    align-items:center;
    gap: 10px;
    justify-content: flex-end;
  }

  .navlink{
    display:inline-flex;
    align-items:center;
    padding: 9px 12px;
    border-radius: 999px;
    font-weight: 900;
    font-size: 15px;
    color: rgba(27,27,27,0.88);
    text-decoration: none;
    border: 1px solid transparent;
    background: transparent;
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
  }

  .navlink:hover{
    text-decoration: none;
    background: rgba(0,0,0,0.06);
    transform: translateY(-1px);
  }

  .navlink:active{
    transform: translateY(0px) scale(0.99);
  }

  .topbar .navlink[aria-current="page"]{
    background: var(--brand2);
    color: var(--brand);
    border-color: rgba(244,24,76,0.25);
  }

  /* TYPOGRAPHY / SECTION HEADERS */
  h1{
    margin: 14px 0 6px;
    font-size: 34px;
    letter-spacing: -0.5px;
    line-height: 1.15;
  }

  .sub{
    margin: 0 0 16px;
    color: var(--muted);
    font-size: 16px;
  }

  .sectionHead{ text-align: center; }

  .sectionTitle{
    position: relative;
    display: block;
    width: fit-content;
    margin: 6px auto 16px;
    font-size: 28px;
    font-weight: 780;
    letter-spacing: -0.3px;
  }

  /* Add extra space ONLY under Unlocks + Activity */
  h2.sectionTitle:nth-of-type(2),
  h2.sectionTitle:nth-of-type(3){
    margin-bottom: 22px;
  }

  .sectionTitle::after{
    content:"";
    position: absolute;
    left: 0;
    bottom: -3px;
    width: 100%;
    height: 5px;
    border-radius: 6px;
    background: linear-gradient(
      90deg,
      #ff2d6f 0%,
      var(--brand) 35%,
      #9fdf28 70%,
      #ff2d6f 100%
    );
    background-size: 200% 100%;
    animation: titleShimmer 3s linear infinite;
    box-shadow: 0 4px 12px rgba(244,24,76,0.35);
  }

  @keyframes titleShimmer{
    0%{ background-position: 0% 50%; }
    100%{ background-position: 200% 50%; }
  }

  /* BUTTONS */
  button{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    cursor:pointer;
    background:#fff;
    font-weight: 900;
  }

  button:disabled{ opacity: .6; cursor: not-allowed; }

  .btnPrimary{
    background: var(--brand);
    color: #fff;
    border-color: rgba(244,24,76,0.35);
  }

  /* CARDS / COMMON ROWS */
  .card{
    background: rgba(255,255,255,0.95);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px;
    margin: 12px 0;
    box-shadow: 0 10px 28px rgba(0,0,0,.06);
    transition: box-shadow .15s ease, transform .15s ease;
  }

  .card:hover{
    box-shadow: 0 14px 28px rgba(0,0,0,.07);
    transform: translateY(-1px);
  }

  .subcard{
    margin: 10px 0 0;
    box-shadow: 0 8px 18px rgba(0,0,0,.04);
    padding: 12px;
  }

  .subcard:hover{
    box-shadow: 0 14px 28px rgba(0,0,0,.06);
    transform: translateY(-1px);
  }

  .row{
    display:flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: nowrap; /* keep one row on desktop */
  }

  /* CONNECT / STATUS / CREDITS */
  .connectBlock{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .statusBlock{
    text-align: right;
  }

  .creditsLine{
    font-size: 14px;
    color: rgba(27,27,27,0.80);
    font-weight: 800;
  }
  .creditsLine strong{
    font-size: 16px;
    font-weight: 1000;
  }

  .creditsBox{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 4px;
  }

  .creditsMain{
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 26px;
    font-weight: 1000;
    letter-spacing: -0.5px;
  }

  .creditsIcon{ font-size: 22px; }
  .creditsAmount{ font-size: 30px; font-weight: 1000; }
  .creditsLabel{ font-size: 16px; font-weight: 800; opacity: .75; }
  .creditsSub{ font-size: 13px; opacity: .6; }

  .patreonRowLeft{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .patreonSub{
    font-size: 13px;
    font-weight: 800;
    opacity: .65;
    margin-top: -2px;
    padding-left: 4px;
  }

  .patreonRow{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap: 10px;
    margin-top: 8px;
  }

  /* PILLS */
  .pill{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(20,20,20,0.14);
    background: #fff;
    font-weight: 900;
    font-size: 13px;
    color: #333;
  }

  .pillDot{
    width: 10px;
    height: 10px;
    border-radius: 999px;
    display:inline-block;
    flex: 0 0 10px;
  }

  .pill--blue  .pillDot{ background:#56a7fe; }
  .pill--green .pillDot{ background:#22c55e; }
  .pill--amber .pillDot{ background:#f59e0b; }
  .pill--red   .pillDot{ background:#ef4444; }
  .pill--gray  .pillDot{ background:#9ca3af; }

  /* INFO BUTTON + POPUP */
  .infoBtn{
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 1px solid rgba(20,20,20,0.14);
    background: #fff;
    font-weight: 900;
    cursor: pointer;
    display:inline-flex;
    align-items:center;
    justify-content: flex-start;
    padding-left: 12px;
    gap: 8px;
    overflow: visible;
  }
  .infoBtn:hover{ background: rgba(0,0,0,0.06); }

  .infoPop{
    position: fixed;
    inset: 0;
    display:none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 50;
    background: rgba(0,0,0,0.18);
  }
  .infoPop.show{ display:flex; }

  .infoPopInner{
    width: min(520px, 100%);
    background: #fff;
    border: 1px solid rgba(20,20,20,0.14);
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.18);
  }
  .infoPopTitle{ font-weight: 1000; margin-bottom: 8px; }
  .infoPopBody{ font-size: 14px; color: #333; line-height: 1.5; }

  .infoClose{
    margin-top: 12px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(20,20,20,0.14);
    background: #fff;
    font-weight: 900;
    cursor: pointer;
  }

  /* STORE */
  .storeGrid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
  }

  .storeImg{
    width: 100%;
    height: 240px;
    object-fit: contain;
    background: #fff;
    border-radius: 14px;
    border: 1px solid rgba(20,20,20,0.08);
  }

  .storeButton{
    margin-top: 10px;
    width: 100%;
  }

  .storeMeta{
    margin-top: 12px;
    text-align: center;
  }

  .storeTitle{
    font-weight: 1000;
    font-size: 18px;
    margin-bottom: 4px;
  }

  .storeInfo{
    font-size: 16px;
    opacity: .75;
    font-weight: 700;
  }

  .storeMsg{
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(20,20,20,0.12);
    background: rgba(255,255,255,0.9);
    font-size: 13px;
    color: rgba(27,27,27,0.86);
    display: none;
  }
  .storeMsg.show{ display: block; }

  .storeMsg--success{
    border-color: rgba(34,197,94,0.30);
    background: rgba(34,197,94,0.10);
  }
  .storeMsg--error{
    border-color: rgba(239,68,68,0.30);
    background: rgba(239,68,68,0.10);
  }
  .storeMsg--info{
    border-color: rgba(86,167,254,0.30);
    background: rgba(86,167,254,0.10);
  }

  /* UNLOCKS */
  .keybox{
    background:#fff;
    padding:10px;
    border-radius:12px;
    border:1px dashed rgba(20,20,20,0.18);
  }

  /* TOASTS */
  .toastWrap {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(3px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease;
    z-index: 9999;
  }
  .toastWrap.show {
    opacity: 1;
    pointer-events: auto;
  }
  .toast {
    min-width: 280px;
    min-width: 500px;
    padding: 20px 28px;
    border-radius: 16px;
    font-size: 20px;
    font-weight: 500;
    text-align: center;
    color: white;
    background: rgba(31, 41, 55, 0.5); /* 50% opacity */
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
    transform: scale(0.94);
    transition: opacity 0.2s ease, transform 0.2s ease;
    animation: toastPop 0.18s ease-out forwards;
  }
  .toast strong{ font-weight: 1000; }
  .toast.mint  { background: rgba(22, 163, 74, 0.9); }
  .toast.blue  { background: rgba(37, 99, 235, 0.9); }
  .toast.red   { background: rgba(220, 38, 38, 0.9); }

  @keyframes toastPop {
    to {
      transform: scale(1);
    }
  }
  /* ACTIVITY FEED */
  .activityList{ display:flex; flex-direction:column; gap:10px; }

  .activityPillWrap{
    width: 130px;
    flex: 0 0 130px;
  }

  .activityPill.pill--green{ background: rgba(34,197,94,0.10); border-color: rgba(34,197,94,0.22); }
  .activityPill.pill--red{   background: rgba(239,68,68,0.10); border-color: rgba(239,68,68,0.22); }
  .activityPill.pill--blue{  background: rgba(86,167,254,0.10); border-color: rgba(86,167,254,0.22); }

  .activityItem{
    background:#fff;
    border:1px solid rgba(20,20,20,0.10);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 10px 28px rgba(0,0,0,.04);
    transition: box-shadow .15s ease, transform .15s ease;
  }

  .activityItem:hover{
    box-shadow: 0 14px 28px rgba(0,0,0,.06);
    transform: translateY(-1px);
  }

  .activityRow{
    display:flex;
    align-items:center;
    gap: 30px;
    flex-wrap: nowrap;
  }

  .activityText{ min-width: 0; }
  .activityText strong,
  .activityReason{
    overflow-wrap: anywhere;
    word-break: break-word;
  }

  .activityAmt{
    width: 130px;
    flex: 0 0 130px;
    font-weight: 1000;
    font-size: 18px;
    line-height: 1.2;
    white-space: nowrap;
  }
  .activityAmt.plus{ color:#16a34a; }
  .activityAmt.minus{ color:#dc2626; }

  .activityReason{
    display:block;
    margin-top:4px;
    font-size:15px;
    font-style: italic;
    font-family: "Georgia", "Times New Roman", serif;
    opacity:.75;
  }

  .activityTime{
    font-size: 13px;
    color: rgba(27,27,27,0.65);
    white-space: nowrap;
    margin-left: auto;
  }

  .activityPill{
    width: 100%;
    font-size: 17px;
    font-weight: 1000;
    padding: 6px 11px;
    justify-content: center;
    border-color: rgba(20,20,20,0.10);
    background: rgba(255,255,255,0.95);
  }

  /* FOOTER */
  footer{
    margin-top: 26px;
    padding: 18px 0 34px;
    color: rgba(27,27,27,0.72);
    font-size: 14px;
  }

  .hangout{
    text-align: center;
    margin: 18px 0 14px;
    font-size: 15px;
    color: rgba(27,27,27,0.78);
  }

  .footerInner{
    border-top: 1px solid var(--border);
    padding-top: 14px;
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 12px;
    align-items:center;
  }

  .socialText{
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
    justify-content:center;
    align-items:center;
    font-weight: 900;
  }

  .socialText a{
    padding: 2px 6px;
    border-radius: 10px;
    text-decoration: none;
  }
  .socialText a:hover{
    background: rgba(0,0,0,0.06);
    text-decoration: none;
  }

  .sepDot{
    width: 6px;
    height: 6px;
    background: var(--brand);
    border-radius: 50%;
    display: inline-block;
    margin: 0 10px;
  }

  .footerRight{
    display:flex;
    gap: 10px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  .sep{
    color: rgba(20,20,20,0.35);
    font-weight: 800;
    margin: 0 2px;
  }

  /* MOBILE / RESPONSIVE */
  @media (max-width: 900px){
    html, body{ height: auto; }
    .topbarInner{ align-items: flex-start; flex-direction: column; align-items: center; }
    nav{ justify-content: flex-start; }
    .footerInner{ grid-template-columns: 1fr; text-align:center; }
    .footerRight{ justify-content: center !important; }
    .socialText{ justify-content: center !important; }
  }

  @media (max-width: 600px){
    .topbarInner{
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    nav{
      justify-content: flex-start;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 2px 2px 4px;
      scroll-snap-type: x mandatory;
      -webkit-mask-image: linear-gradient(to right,
        transparent 0,
        #000 16px,
        #000 calc(100% - 16px),
        transparent 100%
      );
              mask-image: linear-gradient(to right,
        transparent 0,
        #000 16px,
        #000 calc(100% - 16px),
        transparent 100%
      );
    }
    nav::-webkit-scrollbar{ display:none; }

    .navlink{
      flex: 0 0 auto;
      white-space: nowrap;
      scroll-snap-align: start;
      background: rgba(255,255,255,0.90);
      border-color: rgba(20,20,20,0.12);
    }

    .badge{
      font-size: 13px;
      padding: 6px 10px;
    }

    /* Layout stack */
    .row{
      flex-direction: column;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .connectBlock{
      width: 100%;
      align-items: center;
    }

    .statusBlock{ text-align:center; }

    /* Mobile connect button polish */
    #connect{
      width: 95% !important;
      max-width: 360px;
      min-width: 260px;
      padding: 14px 16px;
      font-size: 18px;
      border-radius: 14px;
      box-shadow: 0 12px 26px rgba(244,24,76,.20);
    }

    .patreonRowLeft{
      justify-content: center;
      gap: 10px;
      margin-top: 6px;
    }

    #patreonPill{
      font-size: 15px;
      padding: 8px 12px;
      font-weight: 1000;
    }

    .infoBtn{
      width: 32px;
      height: 32px;
      font-size: 15px;
      padding-left: 13px;
    }
  }

  @media (max-width: 520px){
    .activityRow{
      display: grid;
      grid-template-columns: 120px 1fr;
      grid-template-areas:
        "pill text"
        "pill time";
      column-gap: 12px;
      row-gap: 6px;
      align-items: center;
    }

    .activityPillWrap{
      width: 120px;
      flex: none;
      grid-area: pill;
    }

    .activityText{
      grid-area: text;
      white-space: normal;
    }

    .activityTime{
      grid-area: time;
      margin-left: 0;
      justify-self: start;
    }
  }

  /* CONFETTI / SPARKLES SAFETY */
  canvas,
  #sparkles,
  .sparkles,
  .sparkle-canvas,
  [class*="sparkle"]{
    pointer-events: none !important;
    touch-action: none !important;
  }

  /* Center + enlarge empty-state messages (Unlocks + Activity) */
  #unlocks.muted,
  #activity.muted{
    text-align: center;
    font-size: 15px;      /* same feel as ‚ÄúWant to hang out?‚Äù */
    color: rgba(27,27,27,0.78);
    margin-top: 6px;
  }
</style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <span class="badge">RPG Maker Systems ‚Ä¢ Mechanics ‚Ä¢ Game Development</span>
      </div>

      <nav aria-label="Primary">
        <a class="navlink" href="./">Home</a>
        <a class="navlink" href="./redeem.html" aria-current="page">Rewards</a>
        <a class="navlink" href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Smart Systems</a>
        <a class="navlink" href="https://anyalolo.substack.com/" target="_blank" rel="noopener">Our Blog</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Patreon Rewards</h1>
    <p class="sub">
      Connect your Patreon to view your credits and redeem itch.io keys.
      Credits are earned from successful paid Patreon pledges.
    </p>

<div class="card" style="margin: 10px 0 14px;">
  <div class="row">

    <!-- LEFT COLUMN -->
    <div class="connectBlock">
      <button id="connect" class="btnPrimary">Connect Patreon</button>

      <div class="patreonRowLeft">
        <span id="patreonPill" class="pill pill--gray">
          <span class="pillDot"></span> Patreon: not connected
        </span>
        <button id="infoBtn" class="infoBtn" type="button" aria-label="Patreon credits info">i</button>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="statusBlock">
      <div class="creditsBox">
        <div class="creditsMain">
          <span class="creditsIcon">üí∞</span>
          <span id="creditsValue" class="creditsAmount">0</span>
          <span class="creditsLabel">Credits</span>
        </div>
        <div class="creditsSub">1¬¢ = 1 credit</div>
      </div>
    </div>

  </div>
</div>

    <div id="infoPop" class="infoPop" aria-hidden="true">
      <div class="infoPopInner" role="dialog" aria-modal="false">
        <div class="infoPopTitle">Patreon credits info</div>
        <div id="infoPopBody" class="infoPopBody">
          Your current Patreon status: ‚Äî<br>
          If the payment hasn‚Äôt processed yet, or the patron is declined/cancelled, your credits may not yet appear.
        </div>
        <button id="infoClose" class="infoClose" type="button">Close</button>
        <button id="copySupport" class="infoClose" type="button">Copy Support Info</button>
        <div class="muted" id="supportCopied" style="margin-top:8px;"></div>
      </div>
    </div>

<div class="card">
  <div class="sectionHead"><h2 class="sectionTitle">Rewards Store</h2></div>
  <div id="store" class="storeGrid"></div>

  <div class="sectionHead"><h2 class="sectionTitle">Your Unlocks</h2></div>
  <div id="unlocks" class="muted">Redeem something to see it here.</div>
</div>

<div class="card">
  <div class="sectionHead"><h2 class="sectionTitle">Account activity</h2></div>
  <div id="activity" class="muted">
    Connect Patreon to see recent activity on your account.
  </div>

  <footer style="margin-top: 18px;">
    <div class="hangout">
      Want to hang out? Join the
      <a href="https://discord.com/invite/4Pyb5SQTdn" target="_blank" rel="noopener" style="color:var(--brand); font-weight:900;">Discord</a>
      or follow us on your favourite platform below üíõ
    </div>

    <div class="footerInner">
      <div>¬© <span id="year"></span> Anya &amp; Lolo</div>

      <div class="socialText" aria-label="Social links">
        <a href="https://www.youtube.com/@Anya_and_Lolo" target="_blank" rel="noopener">YouTube</a>
        <a href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Itch</a>
        <a href="https://www.patreon.com/anya_and_lolo" target="_blank" rel="noopener">Patreon</a>

        <span class="sepDot"></span>

        <a href="https://www.instagram.com/anya_and_lolo" target="_blank" rel="noopener">Insta</a>
        <a href="https://tiktok.com/@anya_and_lolo" target="_blank" rel="noopener">TikTok</a>
        <a href="https://www.facebook.com/316257814895497" target="_blank" rel="noopener">Facebook</a>

        <span class="sepDot"></span>

        <a href="https://bsky.app/profile/anya-and-lolo.itch.io" target="_blank" rel="noopener">Bluesky</a>
        <a href="https://x.com/Anya_and_Lolo" target="_blank" rel="noopener">X</a>

        <span class="sepDot"></span>

        <a href="https://www.pixiv.net/en/users/105118068" target="_blank" rel="noopener">Pixiv</a>
        <a href="https://anya-and-lolo.booth.pm/" target="_blank" rel="noopener">Booth</a>
      </div>

      <div class="footerRight">
        <a href="./terms.html">Terms</a>
        <span class="sep">|</span>
        <a href="./privacy.html">Privacy</a>
      </div>
    </div>
  </footer>
</div>
  </main>

<script>
/* BOOTSTRAP / GLOBALS */
document.getElementById("year").textContent = new Date().getFullYear();

const API = "https://patreon-redeem-api.lady-anya.workers.dev";
const params = new URLSearchParams(location.search);
const DEBUG = params.get("debug"); // "anya" or null

let CURRENT_CREDITS_CENTS = 0; // integer cents

// --- Support bundle state (safe diagnostics)
let LAST_ME = null;
let LAST_ENTITLEMENTS = null;
let LAST_ACTIVITY = null;

// Owned items cache for store UI
let OWNED_ITEM_IDS = new Set();

// Session from URL
const sessionFromUrl = params.get("session");
if (sessionFromUrl) localStorage.setItem("session", sessionFromUrl);

// Redeem lock per item
const redeeming = new Set();

// TOAST CONTROLLER (centered overlay, click/Esc to close, supports confetti triggers)
let TOAST_TIMER = null;
let TOAST_EL = null;
  
// Images
const ITEM_IMAGES = {
  fishing_system: "https://anya-and-lolo.github.io/images/fishing_system_image.jpg",
  visual_novel_system: "https://anya-and-lolo.github.io/images/VN_system_image.jpg",
  shooting_system: "https://anya-and-lolo.github.io/images/shooting_system_image.jpg",
};

// Hook connect button (connect + reconnect use same flow)
document.getElementById("connect").onclick = () => {
  location.href = API + "/auth/patreon/start";
};


/* STORAGE KEYS */
const SUPPORT_ID_KEY = "support_id_v1";
const LAST_CREDITS_KEY = "last_credits_raw_cents_v1";
const LAST_ACTIVITY_SEEN_KEY = "last_activity_seen_v1";


/* URL / SESSION HELPERS */
function apiUrl(path, session) {
  const u = new URL(API + path);
  if (session) u.searchParams.set("session", session);
  if (DEBUG) u.searchParams.set("debug", DEBUG);
  return u.toString();
}

function getSession() {
  return localStorage.getItem("session");
}


/* SUPPORT ID (stable per device/browser) */
function makeSupportId(){
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no confusing O/0/I/1
  const part = (len) => Array.from({length: len}, () => alphabet[Math.floor(Math.random() * alphabet.length)]).join("");
  return `AL-${part(4)}-${part(4)}`;
}

function getSupportId(){
  let id = localStorage.getItem(SUPPORT_ID_KEY);
  if (!id) {
    id = makeSupportId();
    localStorage.setItem(SUPPORT_ID_KEY, id);
  }
  return id;
}


/* SAFE TEXT / FORMATTERS */
function escapeHtml(str){
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function isProbablyUrl(s) {
  return typeof s === "string" && /^https?:\/\//i.test(s.trim());
}

function fmtPrettyWhen(iso){
  try{
    const d = new Date(String(iso));
    if (!Number.isFinite(d.getTime())) return "(unknown time)";
    const dayMonth = new Intl.DateTimeFormat("en-AU", { day:"numeric", month:"long" }).format(d);
    const time = new Intl.DateTimeFormat("en-AU", { hour:"2-digit", minute:"2-digit" }).format(d).toLowerCase();
    return `${dayMonth} ${time}`;
  } catch {
    return "(unknown time)";
  }
}

/* TOASTS  */
function closeToast(animated = true){
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  if (TOAST_TIMER) clearTimeout(TOAST_TIMER);
  TOAST_TIMER = null;

  const el = TOAST_EL;
  TOAST_EL = null;

  if (!el) {
    wrap.classList.remove("show");
    wrap.innerHTML = "";
    return;
  }

  if (!animated) {
    el.remove();
    wrap.classList.remove("show");
    wrap.innerHTML = "";
    return;
  }

  // Animate out without breaking centering
  el.style.opacity = "0";
  el.style.transform = "scale(0.96)";

  setTimeout(() => {
    el.remove();
    wrap.classList.remove("show");
    wrap.innerHTML = "";
  }, 200);
}

function maybeConfetti(kind){
  if (typeof window.confetti !== "function") return;

  const base = { particleCount: 90, spread: 70, origin: { y: 0.55 } };
  if (kind === "unlock") window.confetti({ ...base, particleCount: 130, spread: 90 });
  else if (kind === "credits") window.confetti(base);
}

function toast(message, variant = "blue", ms = 4200, opts = {}){
  const wrap = document.getElementById("toastWrap");
  if (!wrap) return;

  // IMPORTANT: close instantly so we don't stack/shift during rapid tests
  closeToast(false);

  wrap.classList.add("show");

  const el = document.createElement("div");
  el.className = `toast ${variant || "blue"}`;
  el.innerHTML = `<strong>${escapeHtml(message)}</strong>`;

  wrap.appendChild(el);
  TOAST_EL = el;

  if (opts?.confetti) maybeConfetti(opts.confetti);

  TOAST_TIMER = setTimeout(() => closeToast(true), ms);
}

// close on click anywhere (overlay or toast)
document.getElementById("toastWrap")?.addEventListener("click", () => closeToast(true));

// close on Esc
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeToast(true);
});

function isPositiveActivity(it){
  const src = String(it?.source || "").toLowerCase();
  const delta = Number(it?.delta_cents || 0);

  if (src === "redeem") return true;          // positive to user
  if (src === "entitlement") return true;     // positive
  if (delta > 0) return true;                // credits added/refunded/etc
  return false;
}

function toastForActivity(it){
  const src = String(it?.source || "").toLowerCase();
  const delta = Number(it?.delta_cents || 0);

  if (src === "patreon_charge" && delta > 0) {
    return { msg: "üíñ Patreon support received, thank you! New credits unlocked.", variant: "mint", confetti: true };
  }
  if (src === "refund" && delta > 0) {
    return { msg: "‚úÖ Refund successful! Your credits have been returned.", variant: "mint", confetti: true };
  }
  if (src === "redeem") {
    return { msg: "üéüÔ∏è Redeem successful! Please check 'Your Unlocks'.", variant: "mint", confetti: true };
  }
  if (src === "entitlement") {
    return { msg: "üéÅ New item added! CPlease check 'Your Unlocks'.", variant: "mint", confetti: true };
  }
  if (delta > 0) {
    return { msg: "üéâ Bonus credits added! See Account Activity for more details.", variant: "mint", confetti: true };
  }

  // non-positive / informational
  return { msg: "‚ÑπÔ∏è Account updated. See Account Activity for more details.", variant: "blue", confetti: false };
}

function maybeToastNewActivity(items){
  if (!Array.isArray(items) || items.length === 0) return;

  const lastSeen = localStorage.getItem(LAST_ACTIVITY_SEEN_KEY) || "";
  const newest = items[0]?.created_at || "";
  if (!newest) return;

  // First ever visit: don‚Äôt spam, just set baseline.
  if (!lastSeen) {
    localStorage.setItem(LAST_ACTIVITY_SEEN_KEY, newest);
    return;
  }

  // If there is new activity since last seen, show ONE toast for the newest unseen item.
  if (newest !== lastSeen) {
    const unseen = [];
    for (const it of items){
      if (it?.created_at === lastSeen) break;
      unseen.push(it);
    }

    const pick = unseen.find(isPositiveActivity) || unseen[0];
    if (pick) {
      const t = toastForActivity(pick);
      toast(t.msg, t.variant, 4200, { confetti: t.confetti ? "credits" : null }); 
      // ^ we use "credits" as generic "good news" burst
    }
  }

  localStorage.setItem(LAST_ACTIVITY_SEEN_KEY, newest);
}


/* API FETCH WRAPPER */
async function apiFetch(path, session, opts = {}) {
  const headers = new Headers(opts.headers || {});
  headers.set("x-support-id", getSupportId());
  headers.set("x-page", location.pathname);
  return fetch(apiUrl(path, session), { ...opts, headers });
}


/* UI: PILL + CONNECT BUTTON STATES */
function setPill(status) {
  const pill = document.getElementById("patreonPill");
  if (!pill) return;

  const raw = (status ?? "").toString();
  const s = raw.toLowerCase();

  let cls = "pill--gray";
  let label = "not connected";

  if (!raw || s.includes("not connected")) {
    cls = "pill--gray";
    label = "not connected";
  }
  else if (s.includes("reconnect_required") || s.includes("reconnect")) {
    cls = "pill--amber";
    label = "Reconnect required";
  }
  else if (s.includes("declined")) {
    cls = "pill--red";
    label = "Payment declined";
  }
  else if (s.includes("active")) {
    cls = "pill--green";
    label = "Connected";
  }
  else if (s.includes("not a patron") || s.includes("not pledged") || s.includes("no pledge")) {
    cls = "pill--green";
    label = "Connected ‚Ä¢ No active pledges";
  }
  else if (s.includes("paused") || s.includes("pending")) {
    cls = "pill--amber";
    label = "Connected ‚Ä¢ Membership pending";
  }
  else if (s.includes("error")) {
    cls = "pill--red";
    label = "Error loading status";
  }
  else {
    cls = "pill--amber";
    label = "Status unknown";
  }

  pill.classList.remove("pill--green","pill--amber","pill--red","pill--gray","pill--blue");
  pill.classList.add(cls);

  pill.innerHTML = `<span class="pillDot"></span> Patreon: ${label}`;
}

function showConnectUI(){
  const btn = document.getElementById("connect");

  if (btn){
    btn.style.display = "";
    btn.disabled = false;

    if (window.innerWidth <= 600){
      btn.textContent = "Connect";
    } else {
      btn.textContent = "Connect Patreon";
    }

    btn.dataset.mode = "connect";
  }

  const creditsSub = document.querySelector(".creditsSub");
  if (creditsSub) creditsSub.textContent = "Connect Patreon";
}

function showConnectedUI(){
  const btn = document.getElementById("connect");

  if (btn){
    btn.style.display = "";
    btn.disabled = false;

    if (window.innerWidth <= 600){
      btn.textContent = "Re-connect";
    } else {
      btn.textContent = "Re-connect Patreon";
    }

    btn.dataset.mode = "reconnect";
  }

  const creditsSub = document.querySelector(".creditsSub");
  if (creditsSub) creditsSub.textContent = "1¬¢ = 1 credit";
}


/* LOADERS: /me, /activity, /store, /entitlements */
async function loadMe() {
  const s = getSession();
  const creditsValue = document.getElementById("creditsValue");
  const infoPopBody = document.getElementById("infoPopBody");

  if (!s) {
    LAST_ME = null;
    CURRENT_CREDITS_CENTS = 0;

    if (creditsValue) creditsValue.textContent = "N/A";
    showConnectUI();
    setPill("not connected");

    if (infoPopBody) {
      infoPopBody.innerHTML =
        `Patreon status: <strong>not connected</strong><br>` +
        `Connect your Patreon to see your credits.`;
    }
    return null;
  }

  try {
    const r = await apiFetch("/me", s);
    const me = await r.json();
    LAST_ME = me;

    if (!me.loggedIn) {
      CURRENT_CREDITS_CENTS = 0;
      LAST_ME = null;

      if (creditsValue) creditsValue.textContent = "not connected";
      showConnectUI();
      setPill("not connected");

      if (infoPopBody) {
        infoPopBody.innerHTML =
          `Patreon status: <strong>not connected</strong><br>` +
          `Connect your Patreon to see your credits.`;
      }
      return null;
    }

    if (DEBUG === "anya") {
      if (creditsValue) creditsValue.textContent = "unlimited";
      showConnectedUI();
      setPill("connected");

      if (infoPopBody) {
        infoPopBody.innerHTML =
          `Your current Patreon status: <strong>connected</strong><br>` +
          `Creator mode: unlimited.`;
      }
      return me;
    }

    const cents = Number.isFinite(Number(me.credits_raw_cents)) ? Number(me.credits_raw_cents) : 0;
    CURRENT_CREDITS_CENTS = Math.max(0, Math.floor(cents));

    if (creditsValue) creditsValue.textContent = String(CURRENT_CREDITS_CENTS);

    const prettyStatus = (me.patreon_status ?? "connected").toString();
    setPill(prettyStatus);

    const statusLower = prettyStatus.toLowerCase();
    if (statusLower.includes("reconnect") || statusLower.includes("reconnect_required")) {
      showConnectUI();
    } else {
      showConnectedUI();
    }

    if (infoPopBody) {
      infoPopBody.innerHTML =
        `Your current Patreon status: <strong>${prettyStatus}</strong><br>` +
        `Credits shown are based on your lifetime support for this campaign.`;
    }

    return me;
  } catch (e) {
    LAST_ME = null;
    CURRENT_CREDITS_CENTS = 0;

    if (creditsValue) creditsValue.textContent = "error";
    showConnectUI();
    setPill("error");

    if (infoPopBody) {
      infoPopBody.innerHTML =
        `Your current Patreon status: <strong>error</strong><br>` +
        `Couldn‚Äôt load your Patreon info.`;
    }
    return null;
  }
}

async function loadActivity(){
  const s = getSession();
  const box = document.getElementById("activity");

  if (!s){
    if (box){
      box.classList.add("muted");
      box.textContent = "Connect Patreon to see recent activity on your account.";
    }
    return;
  }

  try{
    const r = await apiFetch("/activity", s);
    let data = null;
    try { data = await r.json(); } catch { data = { error: "Invalid JSON from /activity" }; }
    LAST_ACTIVITY = data;

    if (!r.ok){
      if (box){
        box.classList.add("muted");
        box.textContent = data?.error || "Could not load activity.";
      }
      return;
    }

    const items = Array.isArray(data?.items) ? data.items : [];
    renderActivity(items);
    maybeToastNewActivity(items);
  } catch (e){
    if (box){
      box.classList.add("muted");
      box.textContent = "Network error loading activity.";
    }
  }
}

async function loadStore() {
  const el = document.getElementById("store");
  if (!el) return;

  try {
    const r = await apiFetch("/store", null);
    const data = await r.json();

    el.innerHTML = "";
    const items = data.items || [];

    if (items.length === 0) {
      el.innerHTML = `<div class="muted">No rewards available yet.</div>`;
      return;
    }

    items.forEach(item => {
      const costCreditsLabel = String(Math.floor(Number(item.cost_cents || 0)));
      const remaining = item.remaining ?? 0;
      const img = ITEM_IMAGES[item.id] || "";
      const isOwned = OWNED_ITEM_IDS.has(item.id);

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        ${img ? `<img class="storeImg" src="${img}" alt="${item.name}">` : ""}

        <div class="storeMeta">
          <div class="storeTitle">${item.name}</div>
          <div class="storeInfo">
            ${costCreditsLabel} credits
            ${isOwned ? "‚Ä¢ System Owned ‚úÖ" : `‚Ä¢ ${remaining} keys left`}
          </div>
        </div>

        <button
          class="storeButton"
          ${(isOwned || remaining <= 0) ? "disabled" : ""}
          data-id="${item.id}"
          data-name="${item.name}"
          data-cost-cents="${item.cost_cents}">
          ${isOwned ? "Redeemed" : "Redeem"}
        </button>

        <div class="storeMsg storeMsg--info show">
          ${(item.payload && item.payload.instructions)
            ? item.payload.instructions
            : "Redeem to receive a unique itch.io key."}
        </div>
      `;

      const btn = div.querySelector("button");
      if (!isOwned && remaining > 0) {
        btn.onclick = () => redeem(item.id, btn);
      }

      el.appendChild(div);
    });
  } catch (e) {
    el.innerHTML = `<div class="muted">Store failed to load. Check console for errors.</div>`;
    console.error("loadStore failed", e);
  }
}

async function loadUnlocks() {
  const s = getSession();
  const box = document.getElementById("unlocks");

  OWNED_ITEM_IDS = new Set();

  if (!s) {
    LAST_ENTITLEMENTS = null;
    if (box) { box.classList.add("muted"); box.textContent = "Connect Patreon to see your unlocks."; }
    return;
  }

  const r = await apiFetch("/entitlements", s);
  const data = await r.json();
  LAST_ENTITLEMENTS = data;

  if (!r.ok) {
    if (box) { box.classList.add("muted"); box.textContent = data.error || "Could not load unlocks."; }
    return;
  }

  if (!data.items || data.items.length === 0) {
    if (box) { box.classList.add("muted"); box.textContent = "Redeem something to see it here."; }
    return;
  }

  data.items.forEach(ent => { if (ent?.item_id) OWNED_ITEM_IDS.add(ent.item_id); });

  box.classList.remove("muted");
  box.innerHTML = "";

  data.items.forEach(ent => {
    const title = (ent.payload && ent.payload.title) ? ent.payload.title : ent.item_id;
    const raw = (ent.payload && (ent.payload.itch_key_url || ent.payload.itch_key || ent.payload.url)) || "";
    addUnlock(title, raw);
  });
}


/* RENDER: ACTIVITY + UNLOCKS */
function friendlyActivityText(x){
  const src  = String(x?.source || "").toLowerCase();
  const note = String(x?.public_note || x?.note || "").trim();
  const delta = Number(x?.delta_cents || 0);

  let cleanNote = note
    .replace(/^‚Ä¢\s*/, "")
    .replace(/\s*\(target(?:_store)?=\s*\d+\)\s*/gi, " ")
    .replace(/^\((.*)\)$/s, "$1")
    .trim();

  if (src === "entitlement" || cleanNote.toLowerCase().startsWith("granted entitlement:")) {
    const item = cleanNote.replace(/^granted entitlement:\s*/i, "").trim();
    return {
      title: item ? `Unlocked: ${item}` : "Unlocked a reward",
      detail: cleanNote.toLowerCase().startsWith("granted entitlement:") ? "" : `Reason: ${cleanNote}`
    };
  }

  if (src.startsWith("admin")) {
    cleanNote = cleanNote
      .replace(/^admin_set\s*/i, "Admin set ")
      .replace(/^admin_adjust\s*/i, "Admin adjusted ")
      .replace(/^admin_grant\s*/i, "Admin granted ")
      .trim();
  }

  if (src === "redeem") {
    const clean = cleanNote.replace(/^redeemed\s*/i, "").trim();
    return { title: clean ? `You redeemed ${clean}` : "You redeemed a reward", detail: "" };
  }

  if (delta > 0 && src.startsWith("admin")) {
    return { title: "Yay, bonus credits added! üéâ", detail: cleanNote ? `Reason: ${cleanNote}` : "" };
  }

  if (delta < 0 && src.startsWith("admin")) {
    return { title: "Credit adjustment by Anya", detail: cleanNote ? `Reason: ${cleanNote}` : "" };
  }

  if (src === "patreon_charge") return { title: "Patreon payment processed, your credits arrived üíñ", detail: "" };
  if (src === "refund")        return { title: "Credits refunded", detail: "" };

  return { title: cleanNote || "Account update", detail: "" };
}

function renderActivity(list){
  const box = document.getElementById("activity");
  if (!box) return;

  if (!Array.isArray(list) || list.length === 0){
    box.classList.add("muted");
    box.textContent = "No recent activity yet.";
    return;
  }

  box.classList.remove("muted");

  box.innerHTML = `<div class="activityList">${
    list.map(x => {
      const delta = Number(x?.delta_cents || 0);
      const source = String(x?.source || "").toLowerCase();

      let amount = "";
      let pillCls = "pill--gray";
      let icon = "üí∞";

      if (source === "entitlement") {
        amount = "Unlock";
        pillCls = "pill--blue";
        icon = "üîë";
      }
      else if (delta > 0) {
        amount = `+${Math.abs(Math.trunc(delta))}`;
        pillCls = "pill--green";
        icon = "üí∞";
      }
      else if (delta < 0) {
        amount = `‚àí${Math.abs(Math.trunc(delta))}`;
        pillCls = "pill--red";
        icon = "üí∞";
      }
      else {
        amount = "Info";
        pillCls = "pill--gray";
        icon = "‚ÑπÔ∏è";
      }

      const when = fmtPrettyWhen(x?.created_at);
      const { title, detail } = friendlyActivityText(x);

      return `
        <div class="activityItem">
          <div class="activityRow">
            <div class="activityPillWrap">
              <span class="pill activityPill ${pillCls}">
                <span class="pillDot"></span>
                ${escapeHtml(amount)}
                <span style="opacity:.75;">${icon}</span>
              </span>
            </div>

            <span class="activityText">
              <strong>${escapeHtml(title)}</strong>
              ${detail ? `<span class="activityReason">${escapeHtml(detail)}</span>` : ""}
            </span>

            <span class="activityTime">${escapeHtml(when)}</span>
          </div>
        </div>
      `;
    }).join("")
  }</div>`;
}

function addUnlock(title, rawKeyOrUrl) {
  const box = document.getElementById("unlocks");
  if (!box) return;
  if (box.classList.contains("muted")) box.classList.remove("muted");

  const isUrl = isProbablyUrl(rawKeyOrUrl);
  const keyLabel = isUrl ? "Your itch.io key link:" : "Your itch.io key code:";

  const wrap = document.createElement("div");
  wrap.className = "card subcard";
  wrap.innerHTML = `
    <strong>${title}</strong>
    <div class="keybox" style="margin-top:8px">
      <div>${keyLabel}</div>
      <div><code class="key">${rawKeyOrUrl || "(missing key)"}</code></div>
      <div style="margin-top:8px" class="row">
        <button class="copy">Copy My Key</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Thank you for supporting üíÉ Anya & Lolo ü¶ú Please keep your key safe.
      </div>
    </div>
  `;

  wrap.querySelector(".copy").onclick = async () => {
    await navigator.clipboard.writeText(rawKeyOrUrl || "");
    let msg = wrap.querySelector(".copiedMsg");
    if (!msg) {
      msg = document.createElement("div");
      msg.className = "muted copiedMsg";
      msg.style.marginTop = "8px";
      wrap.querySelector(".keybox")?.appendChild(msg);
    }
    msg.textContent = "üíõ Copied!";
  };

  box.prepend(wrap);
}


/* STORE MESSAGE HELPERS */
function showStoreMessage(buttonEl, msg, type = "info") {
  if (!buttonEl) return;

  const card = buttonEl.closest(".card");
  if (!card) return;

  const box = card.querySelector(".storeMsg");
  if (!box) return;

  const defaultMsg = box.dataset.defaultMsg || box.textContent;
  if (!box.dataset.defaultMsg) box.dataset.defaultMsg = defaultMsg;

  clearTimeout(box._resetTimer);

  box.classList.remove("storeMsg--success","storeMsg--error","storeMsg--info","show");
  box.classList.add("show");

  if (type === "success") box.classList.add("storeMsg--success");
  else if (type === "error") box.classList.add("storeMsg--error");
  else box.classList.add("storeMsg--info");

  box.textContent = msg;

  if (type === "error" || type === "success") {
    box._resetTimer = setTimeout(() => {
      box.classList.remove("storeMsg--success","storeMsg--error");
      box.classList.add("storeMsg--info");
      box.textContent = box.dataset.defaultMsg || defaultMsg;
    }, 3000);
  }
}


/* ACTIONS: REDEEM */
async function redeem(itemId, buttonEl) {
  const s = getSession();

  if (!s) {
    showStoreMessage(buttonEl, "Please connect your Patreon account first.", "error");
    return;
  }

  const itemName = buttonEl?.dataset?.name || itemId;
  const costCents = Number(buttonEl?.dataset?.costCents ?? 0);

  if (CURRENT_CREDITS_CENTS < costCents) {
    showStoreMessage(
      buttonEl,
      `Not enough credits for ${itemName}. You need ${costCents} credits.`,
      "error"
    );
    return;
  }

  if (redeeming.has(itemId)) return;
  redeeming.add(itemId);

  const originalText = buttonEl?.textContent || "Redeem";

  try {
    buttonEl.disabled = true;
    buttonEl.textContent = "Redeeming‚Ä¶";
    showStoreMessage(buttonEl, `Redeeming ${itemName}‚Ä¶`, "success");

    const r = await apiFetch("/redeem", s, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ itemId })
    });

    const out = await r.json();

    if (!r.ok) {
      showStoreMessage(buttonEl, out.error || "Redeem failed. Please try again.", "error");
      return;
    }

    showStoreMessage(buttonEl, `üéâ Success! ${itemName} unlocked. Check ‚ÄúYour Unlocks‚Äù.`, "success");
    toast(`üéâ ${itemName} unlocked! Check ‚ÄúYour Unlocks‚Äù.`, "mint", 4200, { confetti: "unlock" });

    await loadMe();
    await loadUnlocks();
    await loadStore();
  } catch (e) {
    console.error(e);
    showStoreMessage(buttonEl, "Network error. Please try again.", "error");
  } finally {
    redeeming.delete(itemId);
    buttonEl.disabled = false;
    buttonEl.textContent = originalText;
  }
}


/* INFO POPUP HANDLERS */
const infoBtn = document.getElementById("infoBtn");
const infoPop = document.getElementById("infoPop");
const infoClose = document.getElementById("infoClose");

function openInfo(){ infoPop?.classList.add("show"); infoPop?.setAttribute("aria-hidden","false"); }
function closeInfo(){ infoPop?.classList.remove("show"); infoPop?.setAttribute("aria-hidden","true"); }

infoBtn?.addEventListener("click", () => infoPop?.classList.contains("show") ? closeInfo() : openInfo());
infoClose?.addEventListener("click", closeInfo);
infoPop?.addEventListener("click", (e) => { if (e.target === infoPop) closeInfo(); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeInfo(); });


/* SUPPORT INFO COPY (REDACTED) */
function redactKey(s){
  const t = String(s || "");
  if (!t) return "";
  return t.length <= 6 ? t : ("***" + t.slice(-6));
}

document.getElementById("copySupport")?.addEventListener("click", async () => {
  const sessionPresent = !!getSession();
  const supportId = getSupportId();

  // Pull user_id + patreon_user_id from /support
  let support = { user_id: null, patreon_user_id: null };
  try {
    const s = getSession();
    if (s) {
      const r = await apiFetch("/support", s);
      const data = await r.json();
      if (r.ok && data?.loggedIn && data?.support) {
        support.user_id = data.support.user_id ?? null;
        support.patreon_user_id = data.support.patreon_user_id ?? null;
      }
    }
  } catch (e) {
    // ignore
  }

  const entItems = Array.isArray(LAST_ENTITLEMENTS?.items) ? LAST_ENTITLEMENTS.items : [];
  const safeEnt = entItems.map(e => ({
    entitlement_id: e?.id ?? null,
    item_id: e?.item_id ?? null,
    title: e?.payload?.title ?? null,
    claimed_at: e?.payload?.claimed_at ?? null,
    itch_key_code_last6: redactKey(e?.payload?.itch_key_code),
    itch_key_url_present: !!e?.payload?.itch_key_url
  }));

  const safe = {
    app: "Anya & Lolo Patreon Rewards",
    page: location.href.split("?")[0],
    time: new Date().toISOString(),
    session_present: sessionPresent,

    user_id: support.user_id,
    patreon_user_id: support.patreon_user_id,

    loggedIn: LAST_ME?.loggedIn ?? null,
    patreon_status: LAST_ME?.patreon_status ?? null,
    credits_raw_cents: LAST_ME?.credits_raw_cents ?? null,

    entitlements_count: safeEnt.length,
    entitlements: safeEnt,

    ua: navigator.userAgent
  };

  const text =
    `SUPPORT INFO (paste to Anya)\nSupport ID: ${supportId}\n` +
    JSON.stringify(safe, null, 2);

  await navigator.clipboard.writeText(text);

  const msg = document.getElementById("supportCopied");
  if (msg) msg.textContent = "Copied! Paste this to Anya üíõ";
});


/* GLOBAL ERROR LOGS */
window.addEventListener("error", (e) => {
  console.error("Global error:", e.error || e.message);
});
window.addEventListener("unhandledrejection", (e) => {
  console.error("Unhandled promise rejection:", e.reason);
});


/* POLLING BLOCK */
const POLL_MS = 10000; // 10 sec

let LAST_CREDITS_CENTS = null;
let POLL_TIMER = null;

function startCreditsPolling(ms = POLL_MS) {
  if (POLL_TIMER) return;
  if (!getSession()) return; // don't poll if not connected

  async function tick() {
    try {
      if (document.hidden) return;

      // If session disappeared, stop polling
      if (!getSession()) {
        stopCreditsPolling();
        return;
      }

      const r = await apiFetch("/me", getSession());
      const me = await r.json();

      // If no longer logged in, stop polling
      if (!r.ok || !me?.loggedIn) {
        stopCreditsPolling();
        return;
      }

      const now = Number(me?.credits_raw_cents ?? 0);
      if (!Number.isFinite(now)) return;

      if (LAST_CREDITS_CENTS !== null && now !== LAST_CREDITS_CENTS) {
        const diff = now - LAST_CREDITS_CENTS;
          if (diff > 0) {
            toast(`üí∞ Yay! +${diff} credits added!`, "mint", 4200, { confetti: "credits" });
          } else if (diff < 0) {
            toast(`‚ÑπÔ∏è ${Math.abs(diff)} credits changed`, "blue", 4200);
          }
      }

      LAST_CREDITS_CENTS = now;
    } catch (e) {
      // silent
    }
  }

  POLL_TIMER = setInterval(tick, ms);
  tick(); // run once immediately
} // ‚úÖ END of startCreditsPolling

function stopCreditsPolling() {
  if (POLL_TIMER) clearInterval(POLL_TIMER);
  POLL_TIMER = null;
}

document.addEventListener("visibilitychange", () => {
  if (document.hidden) stopCreditsPolling();
  else startCreditsPolling(POLL_MS);
});
  
/* STARTUP */
(async () => {
  try { await loadMe(); } catch(e){}
  try { await loadUnlocks(); } catch(e){}
  try { await loadActivity(); } catch(e){}
  try { await loadStore(); } catch(e){}

  // baseline after first load (prevents a "fake diff" later)
  LAST_CREDITS_CENTS = CURRENT_CREDITS_CENTS;

  startCreditsPolling(POLL_MS);
})();
</script>

  <script src="https://app.embed.im/confetti.js" defer></script>
  <div id="toastWrap" class="toastWrap" aria-live="polite" aria-atomic="true"></div>

</body>
</html>

