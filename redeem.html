<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patreon Rewards â€¢ Anya & Lolo</title>
  <meta name="description" content="Connect Patreon, view credits, and redeem itch.io keys for Anya & Lolo rewards." />

  <style>
    :root{
      --brand: #f4184c;
      --brand2: rgba(244, 24, 76, 0.12);

      --bg: #ffffff;
      --card: rgba(255,255,255,0.88);
      --border: rgba(20,20,20,0.10);
      --text: #1b1b1b;
      --muted: rgba(27,27,27,0.70);

      --radius: 16px;
      --shadow: 0 10px 28px rgba(0,0,0,.10);
    }

    *{ box-sizing: border-box; }
    html, body{
      height: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
      font-size: 17px;
      line-height: 1.6;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      opacity: 1;
      background:
        radial-gradient(circle, rgba(244,24,76,0.22) 2px, transparent 3.5px) 0 0/42px 42px,
        radial-gradient(circle, rgba(86,167,254,0.20) 2px, transparent 3.5px) 21px 21px/42px 42px;
      animation: dotsFloat 22s linear infinite;
    }
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(255, 250, 252, 0.45);
    }
    @keyframes dotsFloat{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(-120px, -90px, 0); }
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; text-underline-offset: 4px; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    button, .navlink, a{
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    button:active, .navlink:active{
      transform: translateY(1px) scale(0.99);
    }

    .btnPrimary:hover{
      box-shadow: 0 14px 30px rgba(244,24,76,.20);
      transform: translateY(-1px);
    }

    a.pop{ animation: pop .28s ease; }
    @keyframes pop{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.04); }
      100%{ transform: scale(1); }
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.72);
      border-bottom: 1px solid var(--border);
    }

    .topbarInner{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }

    .badge{
      font-size: 14px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.85);
      color: var(--muted);
      font-weight: 900;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content: flex-end;
    }

    .navlink{
      display:inline-flex;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 15px;
      color: rgba(27,27,27,0.88);
      text-decoration: none;
      border: 1px solid transparent;
      background: transparent;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .navlink:hover{
      text-decoration: none;
      background: rgba(0,0,0,0.06);
      transform: translateY(-1px);
    }

    .navlink:active{
      transform: translateY(0px) scale(0.99);
    }

    .topbar .navlink[aria-current="page"]{
      background: var(--brand2);
      color: var(--brand);
      border-color: rgba(244,24,76,0.25);
    }

    @media (max-width: 600px){
      .topbarInner{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      nav{
        justify-content: flex-start;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding: 2px 2px 4px;
        scroll-snap-type: x mandatory;
      }
      nav::-webkit-scrollbar{ display:none; }

      .navlink{
        flex: 0 0 auto;
        white-space: nowrap;
        scroll-snap-align: start;
        background: rgba(255,255,255,0.90);
        border-color: rgba(20,20,20,0.12);
      }

      nav{
        -webkit-mask-image: linear-gradient(to right,
          transparent 0,
          #000 16px,
          #000 calc(100% - 16px),
          transparent 100%
        );
                mask-image: linear-gradient(to right,
          transparent 0,
          #000 16px,
          #000 calc(100% - 16px),
          transparent 100%
        );
      }

      .price{
        font-size: 16px;  
        font-weight: 1000; 
        color: rgba(27,27,27,0.88);
      }

      .badge{
        font-size: 13px;
        padding: 6px 10px;
      }
    }

    h1{
      margin: 14px 0 6px;
      font-size: 34px;
      letter-spacing: -0.5px;
      line-height: 1.15;
    }
    .sub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 16px;
    }

    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
      font-weight: 900;
    }
    button:disabled{ opacity: .6; cursor: not-allowed; }

    .btnPrimary{
      background: var(--brand);
      color: #fff;
      border-color: rgba(244,24,76,0.35);
    }

    .card{
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      margin: 12px 0;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    code{ font-size: 14px; }
    .muted{ color: rgba(27,27,27,0.70); font-size: 13px; }

    .keybox{
      background:#fff;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(20,20,20,0.18);
    }

    .storeGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .storeImg{
      width: 100%;
      height: 240px;
      object-fit: contain;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(20,20,20,0.08);
    }

    .storeButton{
      margin-top: 10px;
      width: 100%;
    }

    footer{
      margin-top: 26px;
      padding: 18px 0 34px;
      color: rgba(27,27,27,0.72);
      font-size: 14px;
    }

    .creditsLine{
      font-size: 14px;
      color: rgba(27,27,27,0.80);
      font-weight: 800;
    }
    .creditsLine strong{
      font-size: 16px;
      font-weight: 1000;
    }

    .patreonRow{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 8px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      font-size: 13px;
      color: #333;
    }
    .pillDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
    }

    .pill--blue .pillDot{ background:#56a7fe; }
    .pill--green .pillDot{ background:#22c55e; }
    .pill--amber .pillDot{ background:#f59e0b; }
    .pill--red   .pillDot{ background:#ef4444; }
    .pill--gray  .pillDot{ background:#9ca3af; }

    .infoBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .infoBtn:hover{ background: rgba(0,0,0,0.06); }

    .infoPop{
      position: fixed;
      inset: 0;
      display:none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
      background: rgba(0,0,0,0.18);
    }
    .infoPop.show{ display:flex; }

    .infoPopInner{
      width: min(520px, 100%);
      background: #fff;
      border: 1px solid rgba(20,20,20,0.14);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
    }
    .infoPopTitle{ font-weight: 1000; margin-bottom: 8px; }
    .infoPopBody{ font-size: 14px; color: #333; line-height: 1.5; }

    .infoClose{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.14);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .hangout{
      text-align: center;
      margin: 18px 0 14px;
      font-size: 15px;
      color: rgba(27,27,27,0.78);
    }

    /* Desktop: keep it on the right */
    .statusBlock{
      text-align: right;
    }
    
    /* Mobile: stack nicely under the button */
    @media (max-width: 600px){
      .row{ align-items: flex-start; }
    
      .statusBlock{
        width: 100%;
        text-align: center;
      }
    
      /* Optional: make button full width so it feels tidy */
      #connect{ width: 100%; }
    
      .patreonRow{
        justify-content: center;
      }
    }
    
    .storeMsg{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(20,20,20,0.12);
      background: rgba(255,255,255,0.9);
      font-size: 13px;
      color: rgba(27,27,27,0.86);
      display: none;
    }
    .storeMsg.show{ display: block; }

    .storeMsg--success{
      border-color: rgba(34,197,94,0.30);
      background: rgba(34,197,94,0.10);
    }
    .storeMsg--error{
      border-color: rgba(239,68,68,0.30);
      background: rgba(239,68,68,0.10);
    }
    .storeMsg--info{
      border-color: rgba(86,167,254,0.30);
      background: rgba(86,167,254,0.10);
    }

    .footerInner{
      border-top: 1px solid var(--border);
      padding-top: 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items:center;
    }

    .socialText{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:center;
      align-items:center;
      font-weight: 900;
    }

    .socialText a{
      padding: 2px 6px;
      border-radius: 10px;
      text-decoration: none;
    }
    .socialText a:hover{
      background: rgba(0,0,0,0.06);
      text-decoration: none;
    }

    .sepDot{
      width: 6px;
      height: 6px;
      background: var(--brand);
      border-radius: 50%;
      display: inline-block;
      margin: 0 10px;
    }

    .footerRight{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .sep{
      color: rgba(20,20,20,0.35);
      font-weight: 800;
      margin: 0 2px;
    }

    @media (max-width: 900px){
      html, body{ height: auto; }
      .topbarInner{ align-items: flex-start; flex-direction: column; align-items: center;}
      nav{ justify-content: flex-start; }
      .footerInner{ grid-template-columns: 1fr; text-align:center; }
      .footerRight{ justify-content: center !important; }
      .socialText{ justify-content: center !important; }
    }

    canvas,
    #sparkles,
    .sparkles,
    .sparkle-canvas,
    [class*="sparkle"]{
      pointer-events: none !important;
      touch-action: none !important;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <span class="badge">RPG Maker Systems â€¢ Mechanics â€¢ Game Development</span>
      </div>

      <nav aria-label="Primary">
        <a class="navlink" href="./">Home</a>
        <a class="navlink" href="./redeem.html" aria-current="page">Rewards</a>
        <a class="navlink" href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Smart Systems</a>
        <a class="navlink" href="https://anyalolo.substack.com/" target="_blank" rel="noopener">Our Blog</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Patreon Rewards</h1>
    <p class="sub">Connect Patreon, view credits, and redeem your itch.io keys for Anya & Lolo rewards.</p>

    <div class="card" style="margin: 10px 0 14px;">
      <div class="row">
        <button id="connect" class="btnPrimary">Connect Patreon</button>

        <div class="statusBlock">  
          <div class="creditsLine">
            My Credits: <strong id="creditsValue">N/A</strong> (1Â¢ = 1 credit)
          </div>
        
          <div class="patreonRow">
            <span id="patreonPill" class="pill pill--gray">
              <span class="pillDot"></span> Patreon: not connected
            </span>
        
            <button id="infoBtn" class="infoBtn" type="button" aria-label="Patreon credits info">i</button>
          </div>
        </div>
      </div>
    </div>

    <div id="infoPop" class="infoPop" aria-hidden="true">
      <div class="infoPopInner" role="dialog" aria-modal="false">
        <div class="infoPopTitle">Patreon credits info</div>
        <div id="infoPopBody" class="infoPopBody">
          Your current Patreon status: â€”<br>
          If the payment hasnâ€™t processed yet, or the patron is declined/cancelled, your credits may not yet appear.
        </div>
        <button id="infoClose" class="infoClose" type="button">Close</button>
        <button id="copySupport" class="infoClose" type="button">Copy Support Info</button>
        <div class="muted" id="supportCopied" style="margin-top:8px;"></div>
      </div>
    </div>

    <h2 style="margin: 18px 0 10px;">Rewards Store</h2>
    <div id="store" class="storeGrid"></div>

    <h2 style="margin: 22px 0 10px;">Your Unlocks</h2>
    <div id="unlocks" class="muted">Redeem something to see it here.</div>

    <footer>
      <div class="hangout">
        Want to hang out? Join the
        <a href="https://discord.com/invite/4Pyb5SQTdn" target="_blank" rel="noopener" style="color:var(--brand); font-weight:900;">Discord</a>
        or follow us on your favourite platform below ðŸ’›
      </div>

      <div class="footerInner">
        <div>Â© <span id="year"></span> Anya &amp; Lolo</div>

        <div class="socialText" aria-label="Social links">
          <a href="https://www.youtube.com/@Anya_and_Lolo" target="_blank" rel="noopener">YouTube</a>
          <a href="https://anya-and-lolo.itch.io/" target="_blank" rel="noopener">Itch</a>
          <a href="https://www.patreon.com/anya_and_lolo" target="_blank" rel="noopener">Patreon</a>

          <span class="sepDot"></span>

          <a href="https://www.instagram.com/anya_and_lolo" target="_blank" rel="noopener">Insta</a>
          <a href="https://tiktok.com/@anya_and_lolo" target="_blank" rel="noopener">TikTok</a>
          <a href="https://www.facebook.com/316257814895497" target="_blank" rel="noopener">Facebook</a>

          <span class="sepDot"></span>

          <a href="https://bsky.app/profile/anya-and-lolo.itch.io" target="_blank" rel="noopener">Bluesky</a>
          <a href="https://x.com/Anya_and_Lolo" target="_blank" rel="noopener">X</a>

          <span class="sepDot"></span>

          <a href="https://www.pixiv.net/en/users/105118068" target="_blank" rel="noopener">Pixiv</a>
          <a href="https://anya-and-lolo.booth.pm/" target="_blank" rel="noopener">Booth</a>
        </div>

        <div class="footerRight">
          <a href="./terms.html">Terms</a>
          <span class="sep">|</span>
          <a href="./privacy.html">Privacy</a>
        </div>
      </div>
    </footer>
  </main>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  const API = "https://patreon-redeem-api.lady-anya.workers.dev";
  let CURRENT_CREDITS_CENTS = 0; // integer cents

  // --- Support ID (stable per device/browser) ---
  const SUPPORT_ID_KEY = "support_id_v1";
  
  function makeSupportId(){
    // Example: "AL-8F3K-1Q9D"
    const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no confusing O/0/I/1
    const part = (len) => Array.from({length: len}, () => alphabet[Math.floor(Math.random() * alphabet.length)]).join("");
    return `AL-${part(4)}-${part(4)}`;
  }
  
  function getSupportId(){
    let id = localStorage.getItem(SUPPORT_ID_KEY);
    if (!id) {
      id = makeSupportId();
      localStorage.setItem(SUPPORT_ID_KEY, id);
    }
    return id;
  }

  // --- Support bundle state (safe diagnostics) ---
  let LAST_ME = null;
  let LAST_ENTITLEMENTS = null;

  let OWNED_ITEM_IDS = new Set();

  const params = new URLSearchParams(location.search);
  const DEBUG = params.get("debug"); // "anya" or null

  function apiUrl(path, session) {
    const u = new URL(API + path);
    if (session) u.searchParams.set("session", session);
    if (DEBUG) u.searchParams.set("debug", DEBUG);
    return u.toString();
  }

  const ITEM_IMAGES = {
    fishing_system: "https://anya-and-lolo.github.io/images/fishing_system_image.jpg",
    visual_novel_system: "https://anya-and-lolo.github.io/images/VN_system_image.jpg",
    shooting_system: "https://anya-and-lolo.github.io/images/shooting_system_image.jpg",
  };

  document.getElementById("connect").onclick = () => {
    location.href = API + "/auth/patreon/start";
  };

  const sessionFromUrl = params.get("session");
  if (sessionFromUrl) localStorage.setItem("session", sessionFromUrl);

  function getSession() {
    return localStorage.getItem("session");
  }

  function isProbablyUrl(s) {
    return typeof s === "string" && /^https?:\/\//i.test(s.trim());
  }

function setPill(status) {
  const pill = document.getElementById("patreonPill");
  if (!pill) return;

  const s = String(status || "").toLowerCase();
  let cls = "pill--gray";

  // âšª Not connected FIRST (so it can't be overridden)
  if (s.includes("not connected")) cls = "pill--gray";
  else if (s.includes("not a patron")) cls = "pill--blue";
  else if (s.includes("active")) cls = "pill--green";
  else if (s.includes("paused") || s.includes("pending")) cls = "pill--amber";
  else if (s.includes("declined") || s.includes("error")) cls = "pill--red";
  else if (s.includes("connected")) cls = "pill--green"; // last

  pill.classList.remove("pill--green","pill--amber","pill--red","pill--gray","pill--blue");
  pill.classList.add(cls);
  pill.innerHTML = `<span class="pillDot"></span> Patreon: ${status ?? "unknown"}`;
}

  function showConnectUI(){
    const btn = document.getElementById("connect");
    if (btn) { btn.style.display = ""; btn.disabled = false; btn.textContent = "Connect Patreon"; }
  }

  function showConnectedUI(){
    const btn = document.getElementById("connect");
    if (btn) { btn.disabled = true; btn.textContent = "Connected âœ…"; }
  }

  async function loadMe() {
    const s = getSession();
    const creditsValue = document.getElementById("creditsValue");
    const infoPopBody = document.getElementById("infoPopBody");

    if (!s) {
      LAST_ME = null;
      CURRENT_CREDITS_CENTS = 0;
      if (creditsValue) creditsValue.textContent = "N/A";
      showConnectUI();
      setPill("not connected");
      if (infoPopBody) {
        infoPopBody.innerHTML =
          `Patreon status: <strong>not connected</strong><br>` +
          `Connect your Patreon to see your credits.`;
          updateInfoPopupSupportId();
      }
      return null;
    }

    try {
      const r = await fetch(apiUrl("/me", s));
      const me = await r.json();
      LAST_ME = me;

      if (!me.loggedIn) {
        CURRENT_CREDITS_CENTS = 0;
        LAST_ME = null;
        if (creditsValue) creditsValue.textContent = "not connected";
        showConnectUI();
        setPill("not connected");
        return null;
      }

      // Creator debug mode if you want it:
      if (DEBUG === "anya") {
        if (creditsValue) creditsValue.textContent = "unlimited";
        showConnectedUI();
        setPill("connected");
        if (infoPopBody) infoPopBody.innerHTML = `Patreon status: <strong>connected</strong><br>Creator mode: unlimited.`;
        return me;
      }

      const cents = Number.isFinite(Number(me.credits_raw_cents)) ? Number(me.credits_raw_cents) : 0;
      CURRENT_CREDITS_CENTS = Math.max(0, Math.floor(cents));

      if (creditsValue) creditsValue.textContent = String(CURRENT_CREDITS_CENTS);
      showConnectedUI();

      const prettyStatus = (me.patreon_status ?? "connected").toString();
      setPill(prettyStatus);

      if (infoPopBody) {
        infoPopBody.innerHTML =
          `Your current Patreon status: <strong>${prettyStatus}</strong><br>` +
          `Credits shown are based on your lifetime support for this campaign.`;
          updateInfoPopupSupportId();
      }

      return me;
    } catch (e) {
      LAST_ME = null;
      CURRENT_CREDITS_CENTS = 0;
      if (creditsValue) creditsValue.textContent = "error";
      showConnectUI();
      setPill("error");
      if (infoPopBody) infoPopBody.innerHTML = `Patreon status: <strong>error</strong><br>Couldnâ€™t load your Patreon info.`;
      return null;
    }
  } // âœ… IMPORTANT: closes loadMe()

  const redeeming = new Set();

  async function loadStore() {
    const el = document.getElementById("store");
    if (!el) return;

    try {
      const r = await fetch(apiUrl("/store"));
      const data = await r.json();

      el.innerHTML = "";
      const items = data.items || [];

      if (items.length === 0) {
        el.innerHTML = `<div class="muted">No rewards available yet.</div>`;
        return;
      }

      items.forEach(item => {
        const costCreditsLabel = String(Math.floor(Number(item.cost_cents || 0)));
        const remaining = item.remaining ?? 0;
        const img = ITEM_IMAGES[item.id] || "";
        const isOwned = OWNED_ITEM_IDS.has(item.id);

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${img ? `<img class="storeImg" src="${img}" alt="${item.name}">` : ""}

          <div style="margin-top:10px;">
            <strong>${item.name}</strong><br>
            <span class="muted">
              <strong style="font-size:15px;">${costCreditsLabel} credits</strong>
              â€¢ ${isOwned ? "System Owned âœ…" : `Remaining keys: ${remaining}`}
            </span>
          </div>

          <button
            class="storeButton"
            ${(isOwned || remaining <= 0) ? "disabled" : ""}
            data-id="${item.id}"
            data-name="${item.name}"
            data-cost-cents="${item.cost_cents}">
            ${isOwned ? "Redeemed" : "Redeem"}
          </button>

          <div class="storeMsg storeMsg--info show">
            ${(item.payload && item.payload.instructions)
              ? item.payload.instructions
              : "Redeem to receive a unique itch.io key."}
          </div>
        `;

        const btn = div.querySelector("button");
        if (!isOwned && remaining > 0) {
          btn.onclick = () => redeem(item.id, btn);
        }

        el.appendChild(div);
      });
    } catch (e) {
      el.innerHTML = `<div class="muted">Store failed to load. Check console for errors.</div>`;
      console.error("loadStore failed", e);
    }
  }

  async function loadUnlocks() {
    const s = getSession();
    const box = document.getElementById("unlocks");

    OWNED_ITEM_IDS = new Set();

    if (!s) {
      LAST_ENTITLEMENTS = null;
      if (box) { box.classList.add("muted"); box.textContent = "Connect Patreon to see your unlocks."; }
      return;
    }

    const r = await fetch(apiUrl("/entitlements", s));
    const data = await r.json();
    LAST_ENTITLEMENTS = data;

    if (!r.ok) {
      if (box) { box.classList.add("muted"); box.textContent = data.error || "Could not load unlocks."; }
      return;
    }

    if (!data.items || data.items.length === 0) {
      if (box) { box.classList.add("muted"); box.textContent = "Redeem something to see it here."; }
      return;
    }

    data.items.forEach(ent => { if (ent?.item_id) OWNED_ITEM_IDS.add(ent.item_id); });

    box.classList.remove("muted");
    box.innerHTML = "";

    data.items.forEach(ent => {
      const title = (ent.payload && ent.payload.title) ? ent.payload.title : ent.item_id;
      const raw = (ent.payload && (ent.payload.itch_key_url || ent.payload.itch_key || ent.payload.url)) || "";
      addUnlock(title, raw);
    });
  }

  function addUnlock(title, rawKeyOrUrl) {
    const box = document.getElementById("unlocks");
    if (!box) return;
    if (box.classList.contains("muted")) box.classList.remove("muted");

    const isUrl = isProbablyUrl(rawKeyOrUrl);
    const keyLabel = isUrl ? "Your itch.io key link:" : "Your itch.io key code:";

    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <strong>${title}</strong>
      <div class="keybox" style="margin-top:8px">
        <div>${keyLabel}</div>
        <div><code class="key">${rawKeyOrUrl || "(missing key)"}</code></div>
        <div style="margin-top:8px" class="row">
          <button class="copy">Copy My Key</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Thank you for supporting ðŸ’ƒ Anya & Lolo ðŸ¦œ Please keep your key safe.
        </div>
      </div>
    `;

    wrap.querySelector(".copy").onclick = async () => {
      await navigator.clipboard.writeText(rawKeyOrUrl || "");
      let msg = wrap.querySelector(".copiedMsg");
      if (!msg) {
        msg = document.createElement("div");
        msg.className = "muted copiedMsg";
        msg.style.marginTop = "8px";
        wrap.querySelector(".keybox")?.appendChild(msg);
      }
      msg.textContent = "ðŸ’› Copied!";
    };

    box.prepend(wrap);
  }

function showStoreMessage(buttonEl, msg, type = "info") {
  if (!buttonEl) return;

  const card = buttonEl.closest(".card");
  if (!card) return;

  const box = card.querySelector(".storeMsg");
  if (!box) return;

  const defaultMsg = box.dataset.defaultMsg || box.textContent;
  if (!box.dataset.defaultMsg) box.dataset.defaultMsg = defaultMsg;

  clearTimeout(box._resetTimer);

  box.classList.remove("storeMsg--success","storeMsg--error","storeMsg--info","show");
  box.classList.add("show");

  if (type === "success") box.classList.add("storeMsg--success");
  else if (type === "error") box.classList.add("storeMsg--error");
  else box.classList.add("storeMsg--info");

  box.textContent = msg;

  if (type === "error" || type === "success") {
    box._resetTimer = setTimeout(() => {
      box.classList.remove("storeMsg--success","storeMsg--error");
      box.classList.add("storeMsg--info");
      box.textContent = box.dataset.defaultMsg || defaultMsg;
    }, 3000);
  }
}
  
async function redeem(itemId, buttonEl) {
  const s = getSession();

  // âœ… show message instead of silent return
  if (!s) {
    showStoreMessage(buttonEl, "Please connect your Patreon account first.", "error");
    return;
  }

  const itemName = buttonEl?.dataset?.name || itemId;
  const costCents = Number(buttonEl?.dataset?.costCents ?? 0);

  if (CURRENT_CREDITS_CENTS < costCents) {
    showStoreMessage(
      buttonEl,
      `Not enough credits for ${itemName}. You need ${costCents} credits.`,
      "error"
    );
    return;
  }

  if (redeeming.has(itemId)) return;
  redeeming.add(itemId);

  const originalText = buttonEl?.textContent || "Redeem";

  try {
    buttonEl.disabled = true;
    buttonEl.textContent = "Redeemingâ€¦";
    showStoreMessage(buttonEl, `Redeeming ${itemName}â€¦`, "success");

    const r = await fetch(apiUrl("/redeem", s), {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ itemId })
    });

    const out = await r.json();

    if (!r.ok) {
      showStoreMessage(buttonEl, out.error || "Redeem failed. Please try again.", "error");
      return;
    }

    showStoreMessage(buttonEl, `ðŸŽ‰ Success! ${itemName} unlocked. Check â€œYour Unlocksâ€.`, "success");

    await loadMe();
    await loadUnlocks();
    await loadStore();
  } catch (e) {
    console.error(e);
    showStoreMessage(buttonEl, "Network error. Please try again.", "error");
  } finally {
    redeeming.delete(itemId);
    buttonEl.disabled = false;
    buttonEl.textContent = originalText;
  }
}

  // Info popup handlers (yours are fine)
  const infoBtn = document.getElementById("infoBtn");
  const infoPop = document.getElementById("infoPop");
  const infoClose = document.getElementById("infoClose");

  function openInfo(){ updateInfoPopupSupportId(); infoPop?.classList.add("show"); infoPop?.setAttribute("aria-hidden","false");}
  function closeInfo(){ infoPop?.classList.remove("show"); infoPop?.setAttribute("aria-hidden","true"); }

  infoBtn?.addEventListener("click", () => infoPop?.classList.contains("show") ? closeInfo() : openInfo());
  infoClose?.addEventListener("click", closeInfo);
  infoPop?.addEventListener("click", (e) => { if (e.target === infoPop) closeInfo(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeInfo(); });

  function updateInfoPopupSupportId(){
  const body = document.getElementById("infoPopBody");
  if (!body) return;

  // Keep whatever text is already there, but append Support ID line
  const sid = getSupportId();
  const extra = `<br><br><span class="muted">Support ID:</span> <strong>${sid}</strong>`;
  
  // Prevent duplicating the line if you open popup multiple times
  if (!body.dataset.hasSupportId) {
    body.innerHTML += extra;
    body.dataset.hasSupportId = "1";
  }
}

function redactKey(s){
  const t = String(s || "");
  if (!t) return "";
  // Keep only last 6 chars so you can correlate, but not leak the full key
  return t.length <= 6 ? t : ("***" + t.slice(-6));
}

document.getElementById("copySupport")?.addEventListener("click", async () => {
  const sessionPresent = !!getSession();

  const entItems = Array.isArray(LAST_ENTITLEMENTS?.items) ? LAST_ENTITLEMENTS.items : [];
  const safeEnt = entItems.map(e => ({
    entitlement_id: e?.id ?? null,
    item_id: e?.item_id ?? null,
    title: e?.payload?.title ?? null,
    claimed_at: e?.payload?.claimed_at ?? null,
    itch_key_code_last6: redactKey(e?.payload?.itch_key_code),
    itch_key_url_present: !!e?.payload?.itch_key_url
  }));

  const safe = {
    app: "Anya & Lolo Patreon Rewards",
    support_id: getSupportId(),
    time: new Date().toISOString(),
    page: location.href.split("?")[0],
    session_present: sessionPresent,

    // From /me (if connected)
    loggedIn: LAST_ME?.loggedIn ?? null,
    patreon_status: LAST_ME?.patreon_status ?? null,
    user_id: LAST_ME?.user_id ?? LAST_ME?.userId ?? null,
    patreon_user_id: LAST_ME?.patreon_user_id ?? LAST_ME?.patreonUserId ?? null,
    credits_raw_cents: LAST_ME?.credits_raw_cents ?? null,

    // From /entitlements
    entitlements_count: safeEnt.length,
    entitlements: safeEnt,

    // Optional client info
    ua: navigator.userAgent
  };

const text =
  `SUPPORT INFO (paste to Anya)\nSupport ID: ${safe.support_id}\n\n` +
  JSON.stringify(safe, null, 2);

  await navigator.clipboard.writeText(text);

  const msg = document.getElementById("supportCopied");
  if (msg) msg.textContent = "Copied! Paste this to Anya ðŸ’›";
});

  (async () => {
    await loadMe();
    await loadUnlocks();
    await loadStore();
  })();
</script>

  <script src="https://app.embed.im/confetti.js" defer></script>
</body>
</html>

