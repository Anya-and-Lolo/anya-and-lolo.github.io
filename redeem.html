<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redeem</title>
</head>
<body>
  <h1>Patreon Rewards</h1>

  <button id="connect">Connect Patreon</button>
  <p id="status">Loadingâ€¦</p>

  <script>
    const API = "https://patreon-redeem-api.lady-anya.workers.dev";

    document.getElementById("connect").onclick = () => {
      location.href = API + "/auth/patreon/start";
    };

    const params = new URLSearchParams(location.search);
    const session = params.get("session");
    if (session) localStorage.setItem("session", session);

    async function loadMe() {
      const s = localStorage.getItem("session");
      if (!s) {
        document.getElementById("status").textContent = "Not connected";
        return;
      }

      const r = await fetch(API + "/me?session=" + s);
      const me = await r.json();

      document.getElementById("status").textContent =
        me.loggedIn ? `Credits: ${me.credits}` : "Not connected";
    }

    loadMe();
  </script>
</body>
</html>
