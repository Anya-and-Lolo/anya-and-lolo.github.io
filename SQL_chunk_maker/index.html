<!doctype html>
<html>
<head><meta charset="utf-8"><title>Itch Key SQL Chunker</title></head>
<body>
  <h2>Itch Key SQL Chunker</h2>
  <p>Paste full itch URLs or just key codes. It will output SQL INSERT chunks.</p>

  <label>Item ID: <input id="item" value="fishing_system" /></label>
  <label>Chunk size: <input id="chunk" type="number" value="100" /></label>

  <textarea id="in" rows="12" cols="120" placeholder="Paste keys or URLs here, one per line"></textarea>
  <br><button id="go">Generate SQL</button>
  <br><br>
  <textarea id="out" rows="18" cols="120" placeholder="SQL will appear here"></textarea>

  <script>
    const uuid16 = () => {
      // 32 hex chars, similar to lower(hex(randomblob(16)))
      const a = crypto.getRandomValues(new Uint8Array(16));
      return [...a].map(b => b.toString(16).padStart(2,'0')).join('');
    };

    function extractKey(line) {
      line = line.trim();
      if (!line) return null;
      // Accept full URL like .../download/KEY or just KEY
      const m = line.match(/\/download\/([^?#\s]+)/);
      return (m ? m[1] : line).trim();
    }

    function sqlEscape(s) {
      return s.replace(/'/g, "''");
    }

    document.getElementById('go').onclick = () => {
      const itemId = document.getElementById('item').value.trim();
      const chunkSize = Math.max(1, parseInt(document.getElementById('chunk').value, 10) || 100);

      const lines = document.getElementById('in').value.split(/\r?\n/);
      const keys = lines.map(extractKey).filter(Boolean);

      const chunks = [];
      for (let i = 0; i < keys.length; i += chunkSize) {
        const slice = keys.slice(i, i + chunkSize);
        const values = slice.map(k =>
          `('${uuid16()}','${sqlEscape(itemId)}','${sqlEscape(k)}',0,datetime('now'))`
        ).join(",\n");
        chunks.push(
`-- Chunk ${Math.floor(i/chunkSize)+1}
INSERT INTO itch_keys (id, item_id, itch_key, used, created_at)
VALUES
${values};
`);
      }

      document.getElementById('out').value = chunks.join("\n");
    };
  </script>
</body>
</html>
